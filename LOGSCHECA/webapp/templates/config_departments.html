{% extends "base.html" %}

{% block title %}Configuración de Departamentos{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-people"></i> Configuración de Departamentos</h2>
            <p class="text-muted">Gestiona los departamentos y asigna usuarios</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalDepartment">
                <i class="bi bi-plus-circle"></i> Nuevo Departamento
            </button>
        </div>
    </div>

    <!-- Tarjetas de Departamentos -->
    <div class="row" id="departmentsContainer">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="text-muted mt-2">Cargando departamentos...</p>
        </div>
    </div>
</div>

<!-- Modal para Crear/Editar Departamento -->
<div class="modal fade" id="modalDepartment" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDepartmentTitle">Nuevo Departamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formDepartment">
                    <input type="hidden" id="deptId">
                    
                    <div class="mb-3">
                        <label class="form-label">Nombre del Departamento *</label>
                        <input type="text" class="form-control" id="deptName" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Código *</label>
                        <input type="text" class="form-control" id="deptCode" required>
                        <small class="text-muted">Ej: RH, FIN, OPS</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" id="deptDescription" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="color" class="form-control form-control-color" id="deptColor" value="#6c757d">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Icono</label>
                                <select class="form-select" id="deptIcon">
                                    <option value="bi-people">Personas</option>
                                    <option value="bi-briefcase">Oficina</option>
                                    <option value="bi-cash-stack">Finanzas</option>
                                    <option value="bi-gear">Operaciones</option>
                                    <option value="bi-tools">Mantenimiento</option>
                                    <option value="bi-shield-check">Seguridad</option>
                                    <option value="bi-headset">Soporte</option>
                                    <option value="bi-graph-up">Ventas</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveDepartment()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver/Asignar Miembros -->
<div class="modal fade" id="modalMembers" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Miembros del Departamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="searchUsers" placeholder="Buscar usuarios por nombre...">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="searchUsers()">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                </div>

                <div class="row">
                    <!-- Miembros Actuales -->
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2">Miembros Actuales</h6>
                        <div id="currentMembers" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Usuarios Disponibles -->
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2">Usuarios Disponibles</h6>
                        <div id="availableUsers" style="max-height: 400px; overflow-y: auto;">
                            <p class="text-muted text-center py-3">Use el buscador para encontrar usuarios</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let departments = [];
let currentDeptId = null;

// Cargar departamentos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadDepartments();
});

// Cargar departamentos desde API
async function loadDepartments() {
    try {
        const response = await fetch('/api/departments');
        const data = await response.json();
        
        if (data.success) {
            departments = data.departments;
            renderDepartments();
        } else {
            showError('Error cargando departamentos: ' + data.message);
        }
    } catch (error) {
        showError('Error de conexión: ' + error.message);
    }
}

// Renderizar departamentos
function renderDepartments() {
    const container = document.getElementById('departmentsContainer');
    
    if (departments.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-people" style="font-size: 4rem; color: #ccc;"></i>
                <p class="text-muted mt-3">No hay departamentos configurados</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalDepartment">
                    <i class="bi bi-plus-circle"></i> Crear Primer Departamento
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = departments.map(dept => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header" style="background-color: ${dept.color}; color: white;">
                    <h5 class="mb-0">
                        <i class="bi ${dept.icon}"></i> ${dept.name}
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2"><strong>Código:</strong> ${dept.code}</p>
                    ${dept.description ? `<p class="mb-2">${dept.description}</p>` : ''}
                    
                    <div class="text-center mt-3">
                        <h2 class="mb-0">${dept.member_count}</h2>
                        <small class="text-muted">Miembros</small>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editDepartment(${dept.id})">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewMembers(${dept.id})">
                            <i class="bi bi-people"></i> Miembros
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Guardar departamento
async function saveDepartment() {
    const id = document.getElementById('deptId').value;
    const data = {
        name: document.getElementById('deptName').value,
        code: document.getElementById('deptCode').value,
        description: document.getElementById('deptDescription').value,
        color: document.getElementById('deptColor').value,
        icon: document.getElementById('deptIcon').value
    };
    
    try {
        const url = id ? `/api/departments/${id}` : '/api/departments';
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('modalDepartment')).hide();
            showSuccess(result.message);
            loadDepartments();
            document.getElementById('formDepartment').reset();
        } else {
            showError(result.message);
        }
    } catch (error) {
        showError('Error guardando departamento: ' + error.message);
    }
}

// Editar departamento
function editDepartment(id) {
    const dept = departments.find(d => d.id === id);
    if (!dept) return;
    
    document.getElementById('modalDepartmentTitle').textContent = 'Editar Departamento';
    document.getElementById('deptId').value = dept.id;
    document.getElementById('deptName').value = dept.name;
    document.getElementById('deptCode').value = dept.code;
    document.getElementById('deptDescription').value = dept.description || '';
    document.getElementById('deptColor').value = dept.color;
    document.getElementById('deptIcon').value = dept.icon;
    
    new bootstrap.Modal(document.getElementById('modalDepartment')).show();
}

// Ver miembros
async function viewMembers(deptId) {
    currentDeptId = deptId;
    const modal = new bootstrap.Modal(document.getElementById('modalMembers'));
    modal.show();
    
    loadCurrentMembers();
}

// Cargar miembros actuales
async function loadCurrentMembers() {
    try {
        const response = await fetch(`/api/departments/${currentDeptId}/members`);
        const data = await response.json();
        
        const container = document.getElementById('currentMembers');
        
        if (data.success && data.members.length > 0) {
            container.innerHTML = data.members.map(m => `
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${m.biostar_name}</strong><br>
                                <small class="text-muted">ID: ${m.biostar_user_id}</small>
                                ${m.job_title ? `<br><small>${m.job_title}</small>` : ''}
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeMember(${m.id})">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-muted text-center py-3">No hay miembros asignados</p>';
        }
    } catch (error) {
        document.getElementById('currentMembers').innerHTML = '<p class="text-danger text-center">Error cargando miembros</p>';
    }
}

// Buscar usuarios
async function searchUsers() {
    const query = document.getElementById('searchUsers').value;
    if (!query || query.length < 2) {
        showError('Ingrese al menos 2 caracteres para buscar');
        return;
    }
    
    try {
        const response = await fetch(`/api/user-profiles/search?q=${encodeURIComponent(query)}&unassigned=true`);
        const data = await response.json();
        
        const container = document.getElementById('availableUsers');
        
        if (data.success && data.profiles.length > 0) {
            container.innerHTML = data.profiles.map(p => `
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${p.biostar_name}</strong><br>
                                <small class="text-muted">ID: ${p.biostar_user_id}</small>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="assignMember(${p.id})">
                                <i class="bi bi-plus"></i> Agregar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-muted text-center py-3">No se encontraron usuarios disponibles</p>';
        }
    } catch (error) {
        showError('Error buscando usuarios: ' + error.message);
    }
}

// Asignar miembro
async function assignMember(profileId) {
    try {
        const response = await fetch(`/api/user-profiles/${profileId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({organizational_area_id: currentDeptId})
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('Usuario asignado exitosamente');
            loadCurrentMembers();
            document.getElementById('searchUsers').value = '';
            document.getElementById('availableUsers').innerHTML = '<p class="text-muted text-center py-3">Use el buscador para encontrar usuarios</p>';
            loadDepartments(); // Actualizar contador
        } else {
            showError(data.message);
        }
    } catch (error) {
        showError('Error asignando usuario: ' + error.message);
    }
}

// Remover miembro
async function removeMember(profileId) {
    const result = await Swal.fire({
        title: '¿Remover usuario?',
        text: 'El usuario será removido del departamento',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, remover',
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            const response = await fetch(`/api/user-profiles/${profileId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({organizational_area_id: null})
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess('Usuario removido exitosamente');
                loadCurrentMembers();
                loadDepartments(); // Actualizar contador
            } else {
                showError(data.message);
            }
        } catch (error) {
            showError('Error removiendo usuario: ' + error.message);
        }
    }
}

// Limpiar formulario al cerrar modal
document.getElementById('modalDepartment').addEventListener('hidden.bs.modal', function() {
    document.getElementById('formDepartment').reset();
    document.getElementById('deptId').value = '';
    document.getElementById('modalDepartmentTitle').textContent = 'Nuevo Departamento';
});

// Helpers
function showSuccess(message) {
    Swal.fire({icon: 'success', title: 'Éxito', text: message, timer: 2000, showConfirmButton: false});
}

function showError(message) {
    Swal.fire({icon: 'error', title: 'Error', text: message});
}
</script>
{% endblock %}
