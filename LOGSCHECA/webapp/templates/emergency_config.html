{% extends "base.html" %}

{% block title %}Configuración de Emergencias{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-gear-fill"></i> Configuración de Emergencias</h2>
                    <p class="text-muted mb-0">Gestiona zonas, grupos, usuarios y dispositivos</p>
                </div>
                <span class="badge bg-success" id="realtimeStatus">
                    <i class="bi bi-circle-fill" style="font-size: 8px;"></i> Tiempo Real
                </span>
            </div>
        </div>
    </div>

    <!-- Zonas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-building"></i> Zonas</h5>
                    <button class="btn btn-primary btn-sm" onclick="showCreateZoneModal()">
                        <i class="bi bi-plus-lg"></i> Nueva Zona
                    </button>
                </div>
                <div class="card-body">
                    <div id="zones-container" class="row">
                        <div class="col-12 text-center py-4">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2">Cargando zonas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Zona Seleccionada -->
    <div id="zone-details-section" style="display: none;">
        <!-- Dispositivos de la Zona (para control de emergencias) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-hdd-network"></i> Dispositivos de <span class="selected-zone-name"></span>
                        </h5>
                        <button class="btn btn-warning btn-sm" onclick="showAddDeviceModal()">
                            <i class="bi bi-plus-lg"></i> Agregar Dispositivo
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info small mb-3">
                            <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                            <strong>Control de Emergencias:</strong> Los dispositivos asignados emitirán <strong>sonido de alarma</strong> y <strong>desbloquearán puertas</strong> automáticamente cuando se active una emergencia en esta zona.
                        </div>
                        <div id="devices-container" class="row"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grupos de la zona seleccionada -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-people"></i> Grupos de <span class="selected-zone-name"></span>
                        </h5>
                        <button class="btn btn-success btn-sm" onclick="showCreateGroupModal()">
                            <i class="bi bi-plus-lg"></i> Nuevo Grupo
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="groups-container" class="row"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Modal: Nueva Zona -->
<div class="modal fade" id="createZoneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Zona</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createZoneForm">
                    <div class="mb-3">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" class="form-control" name="color" value="#8B4513">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="createZone()">Crear</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nuevo Grupo -->
<div class="modal fade" id="createGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuevo Grupo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createGroupForm">
                    <div class="mb-3">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" class="form-control" name="color" value="#007bff">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="createGroup()">Crear</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Miembros del Grupo - CENTRADO CON ESTILOS INLINE -->
<div class="modal fade" id="membersModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-lg" style="display: flex; align-items: center; min-height: calc(100% - 1rem); margin: 0.5rem auto;">
        <div class="modal-content" style="margin: auto;">
            <div class="modal-header" style="background: #3E2723; color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-people"></i> Miembros de <span id="group-name"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Buscador de usuarios -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Buscar usuario para agregar</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="userSearch" 
                               placeholder="Escribe nombre o ID (mínimo 2 caracteres)...">
                        <button type="button" class="btn btn-primary" onclick="buscarUsuarios()">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                    <small class="text-muted">Busca entre los usuarios que han registrado acceso hoy</small>
                </div>
                
                <!-- Resultados de búsqueda -->
                <div id="searchResults" class="mb-3" style="display: none;">
                    <label class="form-label fw-bold text-success">Resultados:</label>
                    <div class="list-group" id="searchResultsList" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                
                <hr>
                
                <!-- Lista de miembros actuales -->
                <h6 class="fw-bold">Miembros actuales: <span class="badge bg-primary" id="members-count">0</span></h6>
                <div id="members-list">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <p class="mt-2 small">Cargando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Agregar Dispositivo a Zona -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning bg-opacity-10">
                <h5 class="modal-title">
                    <i class="bi bi-hdd-network"></i> Agregar Dispositivo a Zona
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Seleccionar Dispositivo</label>
                    <select class="form-select" id="deviceSelect">
                        <option value="">Cargando dispositivos...</option>
                    </select>
                </div>
                <div class="alert alert-warning small">
                    <i class="bi bi-exclamation-triangle-fill"></i> Al activar una emergencia, este dispositivo emitirá sonido de alarma y desbloqueará puertas automáticamente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="addDeviceToZone()">
                    <i class="bi bi-plus-lg"></i> Agregar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Editar Zona -->
<div class="modal fade" id="editZoneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Zona</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editZoneForm">
                    <input type="hidden" name="zone_id" id="editZoneId">
                    <div class="mb-3">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" name="name" id="editZoneName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" name="description" id="editZoneDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" class="form-control" name="color" id="editZoneColor" value="#8B4513">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger me-auto" onclick="deleteZone()">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="updateZone()">Guardar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedZoneId = null;
let selectedGroupId = null;

// Cargar zonas al iniciar
document.addEventListener('DOMContentLoaded', () => {
    loadZones();
    loadAvailableDevices();
});

async function loadZones() {
    try {
        const response = await fetch('/api/zones');
        const data = await response.json();
        
        if (data.success) {
            renderZones(data.zones);
        }
    } catch (error) {
        console.error('Error cargando zonas:', error);
    }
}

function renderZones(zones) {
    const container = document.getElementById('zones-container');
    
    if (zones.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No hay zonas. Crea una nueva.</p></div>';
        return;
    }
    
    container.innerHTML = zones.map(zone => `
        <div class="col-md-4 mb-3">
            <div class="card h-100 zone-card ${selectedZoneId === zone.id ? 'border-primary' : ''}" 
                 style="border-left: 4px solid ${zone.color}; cursor: pointer;">
                <div class="card-body" onclick="selectZone(${zone.id}, '${escapeHtml(zone.name)}')">
                    <h5 class="card-title">
                        <i class="${zone.icon}"></i> ${escapeHtml(zone.name)}
                    </h5>
                    <p class="card-text text-muted small">${escapeHtml(zone.description || 'Sin descripción')}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-secondary">${zone.groups_count} grupos</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); showEditZoneModal(${zone.id}, '${escapeHtml(zone.name)}', '${escapeHtml(zone.description || '')}', '${zone.color}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function selectZone(zoneId, zoneName) {
    selectedZoneId = zoneId;
    
    // Actualizar todos los elementos con clase selected-zone-name
    document.querySelectorAll('.selected-zone-name').forEach(el => {
        el.textContent = zoneName;
    });
    
    // Mostrar sección de detalles
    document.getElementById('zone-details-section').style.display = 'block';
    
    // Cargar datos
    loadGroups(zoneId);
    loadZoneDevices(zoneId);
    
    // Resaltar zona seleccionada
    loadZones();
    
    // Scroll suave a la sección
    document.getElementById('zone-details-section').scrollIntoView({ behavior: 'smooth' });
}

async function loadGroups(zoneId) {
    try {
        const response = await fetch(`/api/zones/${zoneId}/groups`);
        const data = await response.json();
        
        if (data.success) {
            renderGroups(data.groups);
        }
    } catch (error) {
        console.error('Error cargando grupos:', error);
    }
}

function renderGroups(groups) {
    const container = document.getElementById('groups-container');
    
    if (groups.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No hay grupos. Crea uno nuevo.</p></div>';
        return;
    }
    
    container.innerHTML = groups.map(group => `
        <div class="col-md-4 mb-3">
            <div class="card h-100" style="border-left: 4px solid ${group.color};">
                <div class="card-body">
                    <h6 class="card-title">${group.name}</h6>
                    <p class="card-text text-muted small">${group.description || 'Sin descripción'}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-info">${group.members_count} miembros</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="showMembersModal(${group.id}, '${group.name}')">
                            <i class="bi bi-people"></i> Ver
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Modales
function showCreateZoneModal() {
    const modal = new bootstrap.Modal(document.getElementById('createZoneModal'));
    document.getElementById('createZoneForm').reset();
    modal.show();
}

function showCreateGroupModal() {
    if (!selectedZoneId) {
        alert('Selecciona una zona primero');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('createGroupModal'));
    document.getElementById('createGroupForm').reset();
    modal.show();
}

async function createZone() {
    const form = document.getElementById('createZoneForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/api/zones', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(Object.fromEntries(formData))
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createZoneModal')).hide();
            loadZones();
            alert('Zona creada exitosamente');
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error creando zona');
    }
}

async function createGroup() {
    const form = document.getElementById('createGroupForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.zone_id = selectedZoneId;
    
    try {
        const response = await fetch('/api/groups', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('createGroupModal')).hide();
            loadGroups(selectedZoneId);
            alert('Grupo creado exitosamente');
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error creando grupo');
    }
}

async function showMembersModal(groupId, groupName) {
    selectedGroupId = groupId;
    document.getElementById('group-name').textContent = groupName;
    
    // Limpiar búsqueda anterior
    document.getElementById('userSearch').value = '';
    document.getElementById('searchResults').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('membersModal'));
    modal.show();
    
    loadMembers(groupId);
    
    // Pre-cargar usuarios para búsqueda
    cargarUsuariosParaBusqueda();
}

async function loadMembers(groupId) {
    try {
        const response = await fetch(`/api/groups/${groupId}/members`);
        const data = await response.json();
        
        if (data.success) {
            renderMembers(data.members);
        }
    } catch (error) {
        console.error('Error cargando miembros:', error);
    }
}

function renderMembers(members) {
    const container = document.getElementById('members-list');
    document.getElementById('members-count').textContent = members.length;
    
    if (members.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No hay miembros. Busca usuarios para agregar.</p>';
        return;
    }
    
    container.innerHTML = `
        <div class="list-group" style="max-height: 400px; overflow-y: auto;">
            ${members.map(member => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${escapeHtml(member.user_name)}</strong>
                        <br><small class="text-muted">ID: ${member.biostar_user_id}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeMember(${member.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('')}
        </div>
    `;
}

// Cache de usuarios para búsqueda
var todosLosUsuarios = [];
var usuariosCargados = false;

// Cargar usuarios al abrir el modal - usa API de BioStar directamente
function cargarUsuariosParaBusqueda() {
    if (usuariosCargados && todosLosUsuarios.length > 0) {
        console.log('Usuarios ya cargados:', todosLosUsuarios.length);
        return;
    }
    
    fetch('/api/users/all')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success && data.users) {
                todosLosUsuarios = data.users;
                usuariosCargados = true;
                console.log('Usuarios BioStar cargados:', todosLosUsuarios.length);
            }
        })
        .catch(function(err) {
            console.error('Error cargando usuarios:', err);
        });
}

// Función de búsqueda - busca en BioStar si no hay cache, o filtra localmente
function buscarUsuarios() {
    var query = document.getElementById('userSearch').value.trim().toLowerCase();
    var container = document.getElementById('searchResults');
    var list = document.getElementById('searchResultsList');
    
    if (!query || query.length < 2) {
        alert('Escribe al menos 2 caracteres');
        return;
    }
    
    // Mostrar loading
    container.style.display = 'block';
    list.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> Buscando...</div>';
    
    // Si tenemos usuarios en cache, filtrar localmente
    if (todosLosUsuarios.length > 0) {
        filtrarUsuarios(query);
        return;
    }
    
    // Si no hay cache, buscar directamente en BioStar
    fetch('/api/users/search?q=' + encodeURIComponent(query))
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success && data.users) {
                if (data.users.length > 0) {
                    renderSearchResults(data.users);
                } else {
                    list.innerHTML = '<div class="list-group-item text-muted text-center">No se encontraron usuarios con "' + query + '"</div>';
                }
            } else {
                list.innerHTML = '<div class="list-group-item text-danger">Error: ' + (data.message || 'Error desconocido') + '</div>';
            }
        })
        .catch(function(err) {
            list.innerHTML = '<div class="list-group-item text-danger">Error: ' + err.message + '</div>';
        });
}

function filtrarUsuarios(query) {
    var list = document.getElementById('searchResultsList');
    
    var resultados = todosLosUsuarios.filter(function(user) {
        var nombre = (user.name || '').toLowerCase();
        var id = String(user.user_id || '').toLowerCase();
        return nombre.indexOf(query) !== -1 || id.indexOf(query) !== -1;
    });
    
    // Limitar a 30 resultados
    resultados = resultados.slice(0, 30);
    
    if (resultados.length > 0) {
        renderSearchResults(resultados);
    } else {
        list.innerHTML = '<div class="list-group-item text-muted text-center">No se encontraron usuarios con "' + query + '"</div>';
    }
}

function renderSearchResults(users) {
    const container = document.getElementById('searchResults');
    const list = document.getElementById('searchResultsList');
    
    list.innerHTML = users.map(user => {
        const userName = escapeHtml(user.name || 'Sin nombre');
        const userId = user.user_id || user.id || 'N/A';
        return `
            <div class="list-group-item list-group-item-action" onclick="addMember('${userId}', '${userName.replace(/'/g, "\\'")}')"
                 style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${userName}</strong>
                        <br><small class="text-muted">ID: ${userId}</small>
                    </div>
                    <i class="bi bi-plus-circle-fill text-success" style="font-size: 1.2rem;"></i>
                </div>
            </div>
        `;
    }).join('');
    
    container.style.display = 'block';
}

async function addMember(biostarUserId, userName) {
    try {
        const response = await fetch(`/api/groups/${selectedGroupId}/members`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                biostar_user_id: biostarUserId,
                user_name: userName
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('userSearch').value = '';
            loadMembers(selectedGroupId);
            alert('Usuario agregado al grupo');
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error agregando usuario');
    }
}

async function removeMember(memberId) {
    const result = await Swal.fire({
        title: '¿Remover usuario?',
        text: 'El usuario será removido del grupo',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, remover',
        cancelButtonText: 'Cancelar'
    });
    
    if (!result.isConfirmed) return;
    
    try {
        const response = await fetch(`/api/groups/${selectedGroupId}/members/${memberId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadMembers(selectedGroupId);
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Usuario removido',
                showConfirmButton: false,
                timer: 2000
            });
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'Error removiendo usuario', 'error');
    }
}

// ==================== DISPOSITIVOS POR ZONA ====================

let availableDevices = [];

async function loadAvailableDevices() {
    try {
        const response = await fetch('/api/devices/available');
        const data = await response.json();
        
        if (data.success) {
            availableDevices = data.devices;
            updateDeviceSelect();
        }
    } catch (error) {
        console.error('Error cargando dispositivos:', error);
    }
}

function updateDeviceSelect() {
    const select = document.getElementById('deviceSelect');
    if (availableDevices.length === 0) {
        select.innerHTML = '<option value="">No hay dispositivos disponibles</option>';
        return;
    }
    
    select.innerHTML = '<option value="">Selecciona un dispositivo...</option>' +
        availableDevices.map(d => `<option value="${d.id}" data-name="${escapeHtml(d.name)}">${escapeHtml(d.name)} (ID: ${d.id})</option>`).join('');
}

async function loadZoneDevices(zoneId) {
    try {
        const response = await fetch(`/api/zones/${zoneId}/devices`);
        const data = await response.json();
        
        if (data.success) {
            renderZoneDevices(data.devices);
        }
    } catch (error) {
        console.error('Error cargando dispositivos de zona:', error);
    }
}

function renderZoneDevices(devices) {
    const container = document.getElementById('devices-container');
    
    if (devices.length === 0) {
        container.innerHTML = '<div class="col-12"><p class="text-muted text-center">No hay checadores asignados. Agrega uno para habilitar detección automática.</p></div>';
        return;
    }
    
    container.innerHTML = devices.map(device => `
        <div class="col-md-4 mb-2">
            <div class="card">
                <div class="card-body py-2 d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-hdd-network text-warning"></i>
                        <strong class="ms-2">${escapeHtml(device.device_name)}</strong>
                        <br><small class="text-muted">ID: ${device.device_id}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeDeviceFromZone(${device.device_id})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function showAddDeviceModal() {
    if (!selectedZoneId) {
        Swal.fire('Error', 'Selecciona una zona primero', 'warning');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('addDeviceModal'));
    modal.show();
}

async function addDeviceToZone() {
    const select = document.getElementById('deviceSelect');
    const deviceId = select.value;
    const deviceName = select.options[select.selectedIndex]?.dataset?.name || `Dispositivo ${deviceId}`;
    
    if (!deviceId) {
        Swal.fire('Error', 'Selecciona un dispositivo', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/zones/${selectedZoneId}/devices`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                device_id: parseInt(deviceId),
                device_name: deviceName
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
            loadZoneDevices(selectedZoneId);
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Checador asignado',
                showConfirmButton: false,
                timer: 2000
            });
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'Error asignando checador', 'error');
    }
}

async function removeDeviceFromZone(deviceId) {
    const result = await Swal.fire({
        title: '¿Remover checador?',
        text: 'El checador ya no detectará presencia en esta zona',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, remover',
        cancelButtonText: 'Cancelar'
    });
    
    if (!result.isConfirmed) return;
    
    try {
        const response = await fetch(`/api/zones/${selectedZoneId}/devices/${deviceId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadZoneDevices(selectedZoneId);
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Checador removido',
                showConfirmButton: false,
                timer: 2000
            });
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'Error removiendo checador', 'error');
    }
}

// ==================== EDITAR ZONA ====================

function showEditZoneModal(zoneId, name, description, color) {
    document.getElementById('editZoneId').value = zoneId;
    document.getElementById('editZoneName').value = name;
    document.getElementById('editZoneDescription').value = description;
    document.getElementById('editZoneColor').value = color;
    
    const modal = new bootstrap.Modal(document.getElementById('editZoneModal'));
    modal.show();
}

async function updateZone() {
    const zoneId = document.getElementById('editZoneId').value;
    const form = document.getElementById('editZoneForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch(`/api/zones/${zoneId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(Object.fromEntries(formData))
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editZoneModal')).hide();
            loadZones();
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Zona actualizada',
                showConfirmButton: false,
                timer: 2000
            });
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'Error actualizando zona', 'error');
    }
}

async function deleteZone() {
    const zoneId = document.getElementById('editZoneId').value;
    
    const result = await Swal.fire({
        title: '¿Eliminar zona?',
        text: 'Se eliminarán todos los grupos y miembros asociados',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    });
    
    if (!result.isConfirmed) return;
    
    try {
        const response = await fetch(`/api/zones/${zoneId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editZoneModal')).hide();
            selectedZoneId = null;
            document.getElementById('zone-details-section').style.display = 'none';
            loadZones();
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Zona eliminada',
                showConfirmButton: false,
                timer: 2000
            });
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'Error eliminando zona', 'error');
    }
}

</script>

<style>
.zone-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: all 0.2s;
}

/* Estilos para modales */
#membersModal .modal-content,
#addDeviceModal .modal-content,
#editZoneModal .modal-content {
    max-height: 85vh;
}

#membersModal .modal-body {
    overflow-y: auto;
    max-height: 65vh;
}

#searchResultsList .list-group-item {
    cursor: pointer;
    transition: background-color 0.2s;
}

#searchResultsList .list-group-item:hover {
    background-color: #e8f4e8;
    border-left: 3px solid #28a745;
}
</style>
{% endblock %}
