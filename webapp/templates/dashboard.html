{% extends "base.html" %}

{% block title %}Dashboard - BioStar Debug Monitor{% endblock %}

{% block content %}
<div class="page-header animate-slide-down">
    <h2>
        <i class="bi bi-speedometer2"></i>
        Dashboard
        <span class="badge bg-success ms-2" id="realtimeStatus">
            <i class="bi bi-circle-fill" style="font-size: 8px;"></i> Tiempo Real
        </span>
    </h2>
</div>

{% if error %}
<div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle"></i> Error al conectar con BioStar. Verifica la configuraci√≥n.
</div>
{% else %}

<!-- Statistics Cards - Solo Accesos Concedidos -->
<div class="row mb-3 mb-md-4">
    <div class="col-6 col-md-4 animate-scale-in" style="animation-delay: 0.1s;">
        <div class="stat-card">
            <h6>Dispositivos</h6>
            <h2>{{ total_devices }}</h2>
            <small><i class="bi bi-hdd-network-fill"></i> Activos</small>
        </div>
    </div>
    <div class="col-6 col-md-4 animate-scale-in" style="animation-delay: 0.2s;">
        <div class="stat-card success">
            <h6>Accesos Hoy</h6>
            <h2>{{ total_granted }}</h2>
            <small><i class="bi bi-check-circle-fill"></i> Concedidos</small>
        </div>
    </div>
    <div class="col-12 col-md-4 animate-scale-in" style="animation-delay: 0.3s;">
        <div class="stat-card">
            <h6>Usuarios √önicos</h6>
            <h2>{{ total_users }}</h2>
            <small><i class="bi bi-people-fill"></i> Hoy</small>
        </div>
    </div>
</div>

<!-- Devices by Type -->
{% for device_type, devices in devices_by_type.items() %}
<div class="card animate-fade-in mb-4" style="animation-delay: {{ loop.index * 0.1 }}s;">
    <div class="card-header">
        <h5 class="mb-0">
            {% if device_type == 'checador' %}
            <i class="bi bi-fingerprint"></i> Checadores
            {% elif device_type == 'puerta' %}
            <i class="bi bi-door-open"></i> Puertas
            {% elif device_type == 'facial' %}
            <i class="bi bi-person-bounding-box"></i> Faciales
            {% else %}
            <i class="bi bi-hdd-network"></i> Otros
            {% endif %}
            <span class="badge bg-secondary ms-2">{{ devices|length }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for device in devices %}
            <div class="col-12 col-sm-6 col-lg-4 mb-3">
                <div class="device-card" data-device-id="{{ device.id }}" onclick="location.href='{{ url_for('debug_device', device_id=device.id) }}'">
                    <div class="device-card-header">
                        <div>
                            <h5>
                                {% if device.alias %}
                                    {{ device.alias }}
                                {% else %}
                                    {{ device.name }}
                                {% endif %}
                            </h5>
                            <small class="text-muted"><i class="bi bi-hash"></i> {{ device.id }}</small>
                            {% if device.location %}
                            <br><small class="text-muted"><i class="bi bi-geo-alt-fill"></i> {{ device.location }}</small>
                            {% endif %}
                        </div>
                        <span class="badge bg-success">
                            <i class="bi bi-circle-fill" style="font-size: 8px;"></i> Activo
                        </span>
                    </div>
                    
                    <div class="device-stats">
                        <div class="device-stat">
                            <strong style="color: var(--success);">{{ device.summary.access_granted }}</strong>
                            <small>Accesos</small>
                        </div>
                        <div class="device-stat">
                            <strong>{{ device.summary.unique_users }}</strong>
                            <small>Usuarios</small>
                        </div>
                    </div>
                    
                    <button class="btn btn-device-debug w-100" onclick="event.stopPropagation(); location.href='{{ url_for('debug_device', device_id=device.id) }}'">
                        <i class="bi bi-bug-fill"></i> Ver Debug
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endfor %}

{% if not devices_by_type %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No se encontraron checadores.
</div>
{% endif %}

{% endif %}

{% block extra_js %}
<script>
let eventSource = null;
let deviceStats = {}; // {device_id: {total_events, access_granted, access_denied, users: Set}}
let allowedDeviceIds = new Set(); // IDs de dispositivos que el usuario puede ver

// Inicializar stats desde el servidor (solo dispositivos permitidos)
{% for device_type, devices in devices_by_type.items() %}
{% for device in devices %}
allowedDeviceIds.add('{{ device.id }}');
deviceStats['{{ device.id }}'] = {
    total_events: {{ device.summary.total_events }},
    access_granted: {{ device.summary.access_granted }},
    access_denied: {{ device.summary.access_denied|default(0) }},
    users: new Set()  // Para rastrear usuarios √∫nicos
};
{% endfor %}
{% endfor %}

console.log('üìã Dispositivos permitidos:', Array.from(allowedDeviceIds));

// ==================== CONECTAR AUTOM√ÅTICAMENTE AL CARGAR ====================
let reconnectAttempts = 0;
let maxReconnectAttempts = 999;
let reconnectDelay = 3000;
let lastHeartbeat = Date.now();
let heartbeatCheckInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Iniciando tiempo real autom√°ticamente...');
    connectRealtimeStream();
    startHeartbeatCheck();
});

function connectRealtimeStream() {
    if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
        console.log('‚ö†Ô∏è SSE ya est√° activo');
        return;
    }
    
    console.log(`üîå Conectando a stream de tiempo real... (intento ${reconnectAttempts + 1})`);
    
    const statusBadge = document.getElementById('realtimeStatus');
    if (statusBadge) {
        statusBadge.classList.remove('bg-success', 'bg-danger');
        statusBadge.classList.add('bg-warning');
        statusBadge.innerHTML = '<i class="bi bi-circle-fill" style="font-size: 8px;"></i> Conectando...';
    }
    
    // Cerrar conexi√≥n anterior si existe
    if (eventSource) {
        eventSource.close();
    }
    
    eventSource = new EventSource('/stream/all-devices?interval=2');
    lastHeartbeat = Date.now();
    
    eventSource.addEventListener('connection', (e) => {
        const data = JSON.parse(e.data);
        console.log('‚úÖ Conectado al stream:', data);
        reconnectAttempts = 0; // Reset intentos
        lastHeartbeat = Date.now();
        
        if (statusBadge) {
            statusBadge.classList.remove('bg-warning', 'bg-danger');
            statusBadge.classList.add('bg-success');
            statusBadge.innerHTML = '<i class="bi bi-circle-fill" style="font-size: 8px;"></i> Tiempo Real';
        }
    });
    
    eventSource.addEventListener('new_event', (e) => {
        const event = JSON.parse(e.data);
        console.log('üì• Nuevo evento:', event);
        lastHeartbeat = Date.now();
        
        // Actualizar estad√≠sticas del dispositivo
        updateDeviceStats(event);
    });
    
    eventSource.addEventListener('heartbeat', (e) => {
        console.log('üíì Heartbeat recibido');
        lastHeartbeat = Date.now();
    });
    
    eventSource.onerror = (error) => {
        console.error('‚ùå Error en SSE:', error);
        
        if (statusBadge) {
            statusBadge.classList.remove('bg-success', 'bg-warning');
            statusBadge.classList.add('bg-danger');
            statusBadge.innerHTML = '<i class="bi bi-circle-fill" style="font-size: 8px;"></i> Desconectado';
        }
        
        if (eventSource.readyState === EventSource.CLOSED) {
            console.log('üîÑ Conexi√≥n cerrada, reconectando...');
            attemptReconnect();
        }
    };
    
    // Detectar cuando la pesta√±a vuelve a estar activa
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && eventSource && eventSource.readyState === EventSource.CLOSED) {
            console.log('üëÅÔ∏è Pesta√±a activa de nuevo, reconectando...');
            attemptReconnect();
        }
    });
}

function startHeartbeatCheck() {
    if (heartbeatCheckInterval) {
        clearInterval(heartbeatCheckInterval);
    }
    
    heartbeatCheckInterval = setInterval(function() {
        const timeSinceLastHeartbeat = Date.now() - lastHeartbeat;
        
        if (timeSinceLastHeartbeat > 45000) {
            console.warn(`‚ö†Ô∏è Sin heartbeat por ${Math.floor(timeSinceLastHeartbeat / 1000)}s, reconectando...`);
            attemptReconnect();
        }
    }, 30000);
}

function attemptReconnect() {
    if (reconnectAttempts >= maxReconnectAttempts) {
        console.error('‚ùå M√°ximo de intentos alcanzado');
        return;
    }
    
    reconnectAttempts++;
    
    if (eventSource) {
        eventSource.close();
        eventSource = null;
    }
    
    const delay = Math.min(reconnectDelay * reconnectAttempts, 30000);
    console.log(`‚è≥ Reconectando en ${delay / 1000}s...`);
    
    setTimeout(function() {
        connectRealtimeStream();
    }, delay);
}

function updateDeviceStats(event) {
    const deviceId = String(event.device_id || event.source_device_id);
    if (!deviceId) return;
    
    // IMPORTANTE: Solo procesar dispositivos que el usuario puede ver
    if (!allowedDeviceIds.has(deviceId)) {
        console.log(`‚è≠Ô∏è Ignorando evento de dispositivo no permitido: ${deviceId}`);
        return;
    }
    
    // Inicializar si no existe
    if (!deviceStats[deviceId]) {
        deviceStats[deviceId] = {
            total_events: 0,
            access_granted: 0,
            access_denied: 0,
            users: new Set()
        };
    }
    
    // Incrementar total
    deviceStats[deviceId].total_events++;
    
    // Incrementar seg√∫n tipo y rastrear usuario
    if (event.badge_class === 'success') {
        deviceStats[deviceId].access_granted++;
        // Agregar usuario al set (para contar √∫nicos)
        if (event.user_id) {
            deviceStats[deviceId].users.add(String(event.user_id));
        }
    } else if (event.badge_class === 'danger') {
        deviceStats[deviceId].access_denied++;
    }
    
    // Actualizar UI del dispositivo
    updateDeviceCard(deviceId);
    
    // Actualizar totales generales
    updateGlobalStats();
}

function updateDeviceCard(deviceId) {
    const stats = deviceStats[deviceId];
    if (!stats) {
        console.warn('No stats found for device:', deviceId);
        return;
    }
    
    // Buscar la card del dispositivo por data-device-id
    const card = document.querySelector(`.device-card[data-device-id="${deviceId}"]`);
    if (!card) {
        console.warn('Card not found for device:', deviceId);
        return;
    }
    
    // Actualizar los n√∫meros
    const statDivs = card.querySelectorAll('.device-stat strong');
    if (statDivs[0]) statDivs[0].textContent = stats.total_events;
    if (statDivs[1]) statDivs[1].textContent = stats.access_granted;
    if (statDivs[2]) statDivs[2].textContent = stats.access_denied;
    
    console.log(`‚úÖ Updated card for device ${deviceId}:`, stats);
    
    // Animaci√≥n de actualizaci√≥n
    card.style.transition = 'transform 0.2s';
    card.style.transform = 'scale(1.02)';
    setTimeout(() => {
        card.style.transform = 'scale(1)';
    }, 200);
}

function updateGlobalStats() {
    // Calcular totales SOLO de dispositivos permitidos
    let totalGranted = 0;
    let allUsers = new Set();
    
    for (const deviceId of allowedDeviceIds) {
        const stats = deviceStats[deviceId];
        if (stats) {
            totalGranted += stats.access_granted;
            // Unir usuarios de todos los dispositivos
            if (stats.users) {
                stats.users.forEach(u => allUsers.add(u));
            }
        }
    }
    
    // Actualizar cards de estad√≠sticas globales
    // [0] = Dispositivos, [1] = Accesos Hoy, [2] = Usuarios √önicos
    const statCards = document.querySelectorAll('.stat-card h2');
    if (statCards[1]) statCards[1].textContent = totalGranted;
    if (statCards[2]) statCards[2].textContent = allUsers.size;
}


// ==================== CLEAR DASHBOARD CACHE ====================

function clearDashboardCache() {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Limpiando...';
    
    // Call API to clear cache for all devices
    fetch('/api/clear-all-cache', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Cache limpiado';
            btn.classList.remove('btn-dashboard-clear-cache');
            btn.classList.add('btn-success');
            
            // Show notification
            showDashboardNotification('success', data.message);
            
            // Reload page after 1 second
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            // Show error
            btn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
            btn.classList.remove('btn-dashboard-clear-cache');
            btn.classList.add('btn-danger');
            
            showDashboardNotification('error', data.error || 'Error al limpiar cache');
            
            // Restore button after 2 seconds
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-dashboard-clear-cache');
                btn.disabled = false;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        btn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
        btn.classList.remove('btn-dashboard-clear-cache');
        btn.classList.add('btn-danger');
        
        showDashboardNotification('error', 'Error de conexi√≥n');
        
        // Restore button after 2 seconds
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-dashboard-clear-cache');
            btn.disabled = false;
        }, 2000);
    });
}

function showDashboardNotification(type, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show notification-toast`;
    notification.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    notification.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>
{% endblock %}
{% endblock %}
