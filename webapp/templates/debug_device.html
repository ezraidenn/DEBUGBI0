{% extends "base.html" %}

{% block title %}Debug {{ device.name }} - BioStar{% endblock %}

{% block extra_css %}
<style>
.new-event-highlight {
    animation: highlightFade 3s ease-in-out;
    background-color: #d4edda !important;
}

@keyframes highlightFade {
    0% { background-color: #28a745; }
    100% { background-color: transparent; }
}

.realtime-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #dc3545;
    margin-right: 5px;
    animation: pulse 2s infinite;
}

.realtime-indicator.connected {
    background-color: #28a745;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
{% endblock %}

{% block content %}
<!-- Device Header Card -->
<div class="device-header-card mb-3">
    <div class="device-header-info">
        <div class="device-icon">
            <i class="bi bi-fingerprint"></i>
        </div>
        <div class="device-details">
            <h1 class="device-title">
                {% if device.alias %}
                    {{ device.alias }}
                {% else %}
                    {{ device.name }}
                {% endif %}
            </h1>
            <div class="device-meta">
                <span class="device-id"><i class="bi bi-hash"></i> {{ device.id }}</span>
                {% if device.location %}
                <span class="device-location"><i class="bi bi-geo-alt-fill"></i> {{ device.location }}</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="action-buttons-container mb-3">
    <button class="btn btn-realtime" id="realtimeBtn" onclick="toggleRealtime()">
        <span class="realtime-indicator" id="realtimeIndicator"></span>
        <i class="bi bi-broadcast"></i>
        <span id="realtimeBtnText">Activar Tiempo Real</span>
    </button>
    <button class="btn btn-refresh" onclick="location.reload()">
        <i class="bi bi-arrow-clockwise"></i> Actualizar
    </button>
    <button class="btn btn-clear-cache" onclick="clearCacheAndReload()">
        <i class="bi bi-trash3"></i> Limpiar Cache
    </button>
    <button class="btn btn-export" onclick="exportDebug()">
        <i class="bi bi-download"></i> Exportar
    </button>
    <a href="{{ url_for('dashboard') }}" class="btn btn-back">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>

<!-- Summary Cards - Clickeable -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card stat-card-clickable" onclick="showStatDetails({{ device.id }}, 'total')">
            <div class="card-body">
                <h6 class="text-muted">Total Eventos</h6>
                <h2>{{ summary.total_events }}</h2>
                <small class="text-muted">Hoy <i class="bi bi-chevron-right"></i></small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card success stat-card-clickable" onclick="showStatDetails({{ device.id }}, 'granted')">
            <div class="card-body">
                <h6 class="text-muted">Accesos Concedidos</h6>
                <h2>{{ summary.access_granted }}</h2>
                <small class="text-muted">Exitosos <i class="bi bi-chevron-right"></i></small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card danger stat-card-clickable" onclick="showStatDetails({{ device.id }}, 'denied')">
            <div class="card-body">
                <h6 class="text-muted">Accesos Denegados</h6>
                <h2>{{ summary.access_denied }}</h2>
                <small class="text-muted">Rechazados <i class="bi bi-chevron-right"></i></small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card warning stat-card-clickable" onclick="showStatDetails({{ device.id }}, 'users')">
            <div class="card-body">
                <h6 class="text-muted">Usuarios Ãšnicos</h6>
                <h2>{{ summary.unique_users }}</h2>
                <small class="text-muted">Diferentes <i class="bi bi-chevron-right"></i></small>
            </div>
        </div>
    </div>
</div>

{% if summary.first_event %}
<div class="alert alert-info">
    <i class="bi bi-clock"></i> 
    <strong>Primer evento:</strong> {{ summary.first_event.strftime('%H:%M:%S') }} | 
    <strong>Ãšltimo evento:</strong> {{ summary.last_event.strftime('%H:%M:%S') }}
</div>
{% endif %}

<!-- Events Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Eventos del DÃ­a</h5>
    </div>
    <div class="card-body">
        {% if events %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Fecha/Hora</th>
                        <th>Tipo de Evento</th>
                        <th>CÃ³digo</th>
                        <th>Usuario</th>
                        <th>Puerta</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                    <tr>
                        <td>
                            {% if event.datetime %}
                                {{ event.datetime.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% set badge_class, event_label = classify_event(event.event_code) %}
                            <span class="badge bg-{{ badge_class }}">{{ event.event_type or event_label }}</span>
                        </td>
                        <td><code>{{ event.event_code }}</code></td>
                        <td>
                            {% if event.user_name %}
                                <strong>{{ event.user_name }}</strong>
                                <br><small class="text-muted">ID: {{ event.user_id }}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if event.door_name %}
                                {{ event.door_name }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i> No hay eventos registrados hoy para este checador.
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const DEVICE_ID = {{ device.id }};
let socket = null;
let isRealtimeEnabled = false;

function exportDebug() {
    fetch('/debug/device/{{ device.id }}/export')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`âœ“ ${data.message}\n\nArchivo: ${data.filename}`);
            } else {
                alert(`âœ— Error: ${data.error}`);
            }
        })
        .catch(error => {
            alert('Error al exportar: ' + error);
        });
}

function toggleRealtime() {
    if (isRealtimeEnabled) {
        stopRealtime();
    } else {
        startRealtime();
    }
}

function startRealtime() {
    console.log('âš¡ Iniciando monitoreo en TIEMPO REAL...');
    console.log('ðŸ“ Device ID:', DEVICE_ID);
    
    // Connect to WebSocket
    socket = io('/realtime', {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
    });
    
    socket.on('connect', function() {
        console.log('âœ“ Conectado al servidor en tiempo real');
        console.log('ðŸ“¡ Socket ID:', socket.id);
        
        // Request monitoring for this device
        console.log('ðŸ“¤ Enviando solicitud de monitoreo para dispositivo:', DEVICE_ID);
        socket.emit('monitor_device', { device_id: DEVICE_ID });
        
        // Update UI
        isRealtimeEnabled = true;
        const btn = document.getElementById('realtimeBtn');
        const indicator = document.getElementById('realtimeIndicator');
        const btnText = document.getElementById('realtimeBtnText');
        
        btn.classList.remove('btn-success');
        btn.classList.add('btn-danger');
        indicator.classList.add('connected');
        btnText.textContent = 'Detener Tiempo Real';
        
        showNotification('âš¡ Tiempo Real ACTIVADO - Esperando eventos...', 'success');
    });
    
    socket.on('monitoring', function(data) {
        console.log('ðŸ“Š Estado de monitoreo:', data);
    });
    
    socket.on('new_event', function(data) {
        console.log('ðŸ”” NUEVO EVENTO RECIBIDO:', data);
        console.log('   - Device ID:', data.device_id);
        console.log('   - Usuario:', data.user_name);
        console.log('   - Tipo:', data.event_type);
        console.log('   - Fecha:', data.datetime);
        
        if (data.device_id === DEVICE_ID) {
            console.log('âœ… Evento es para este dispositivo, procesando...');
            handleNewEvent(data);
        } else {
            console.log('âš ï¸ Evento es para otro dispositivo, ignorando');
        }
    });
    
    socket.on('disconnect', function() {
        console.log('âœ— Desconectado del servidor');
        const indicator = document.getElementById('realtimeIndicator');
        indicator.classList.remove('connected');
        showNotification('âš ï¸ Desconectado del servidor', 'warning');
    });
    
    socket.on('connect_error', function(error) {
        console.error('âŒ Error de conexiÃ³n:', error);
        showNotification('âŒ Error de conexiÃ³n WebSocket', 'danger');
    });
    
    socket.on('error', function(error) {
        console.error('âŒ Error:', error);
    });
}

function stopRealtime() {
    console.log('â¸ Deteniendo tiempo real...');
    
    if (socket) {
        socket.emit('stop_monitor_device', { device_id: DEVICE_ID });
        socket.disconnect();
        socket = null;
    }
    
    isRealtimeEnabled = false;
    const btn = document.getElementById('realtimeBtn');
    const indicator = document.getElementById('realtimeIndicator');
    const btnText = document.getElementById('realtimeBtnText');
    
    btn.classList.remove('btn-danger');
    btn.classList.add('btn-success');
    indicator.classList.remove('connected');
    btnText.textContent = 'Activar Tiempo Real';
    
    showNotification('â¸ Tiempo Real DETENIDO', 'info');
}

function handleNewEvent(eventData) {
    // Show notification
    const eventType = eventData.event_type || 'Evento';
    const userName = eventData.user_name || 'Desconocido';
    showNotification(`ðŸ”” ${eventType}: ${userName}`, 'warning');
    
    // Play sound (optional)
    playNotificationSound();
    
    // Update summary
    updateSummaryRealtime();
    
    // Add event to table (if table exists)
    addEventToTable(eventData);
}

function updateSummaryRealtime() {
    fetch('/api/device/{{ device.id }}/summary')
        .then(response => response.json())
        .then(data => {
            // Update summary cards with animation
            animateNumberChange('.stat-card h2', data.total_events);
            animateNumberChange('.stat-card.success h2', data.access_granted);
            animateNumberChange('.stat-card.danger h2', data.access_denied);
            animateNumberChange('.stat-card.warning h2', data.unique_users);
            
            // Update time info
            if (data.first_event && data.last_event) {
                const timeInfo = document.querySelector('.alert-info');
                if (timeInfo) {
                    timeInfo.innerHTML = `<i class="bi bi-clock"></i> 
                        <strong>Primer evento:</strong> ${data.first_event} | 
                        <strong>Ãšltimo evento:</strong> ${data.last_event}`;
                }
            }
        });
}

function animateNumberChange(selector, newValue) {
    const elements = document.querySelectorAll(selector);
    if (elements.length > 0) {
        const element = elements[0];
        const oldValue = parseInt(element.textContent);
        if (oldValue !== newValue) {
            element.style.transition = 'all 0.3s ease';
            element.style.transform = 'scale(1.2)';
            element.style.color = '#28a745';
            element.textContent = newValue;
            
            setTimeout(() => {
                element.style.transform = 'scale(1)';
                element.style.color = '';
            }, 300);
        }
    }
}

function addEventToTable(eventData) {
    const tbody = document.querySelector('table tbody');
    if (!tbody) return;
    
    // Create new row
    const row = document.createElement('tr');
    row.classList.add('new-event-highlight');
    
    // Format datetime
    const datetime = new Date(eventData.datetime).toLocaleString('es-MX');
    
    // Determine badge color
    let badgeClass = 'bg-secondary';
    if (eventData.event_code === '4864') badgeClass = 'bg-success';
    else if (eventData.event_code === '4865') badgeClass = 'bg-danger';
    else if (eventData.event_code === '20736') badgeClass = 'bg-warning';
    
    row.innerHTML = `
        <td>${datetime}</td>
        <td><span class="badge ${badgeClass}">${eventData.event_type || 'Evento'}</span></td>
        <td><code>${eventData.event_code}</code></td>
        <td>
            ${eventData.user_name ? `<strong>${eventData.user_name}</strong><br><small class="text-muted">ID: ${eventData.user_id}</small>` : '<span class="text-muted">-</span>'}
        </td>
        <td><span class="text-muted">-</span></td>
    `;
    
    // Insert at the beginning
    tbody.insertBefore(row, tbody.firstChild);
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function playNotificationSound() {
    // Simple beep using Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        console.log('No se pudo reproducir sonido');
    }
}

// Auto-start realtime on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ PÃ¡gina cargada - Listo para tiempo real');
    console.log('ðŸ’¡ Click en "Activar Tiempo Real" para monitoreo instantÃ¡neo');
});

// ==================== CLEAR CACHE AND RELOAD ====================

function clearCacheAndReload() {
    const deviceId = {{ device.id }};
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Limpiando...';
    
    // Call API to clear cache
    fetch(`/debug/device/${deviceId}/clear-cache`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Cache limpiado';
            btn.classList.remove('btn-clear-cache');
            btn.classList.add('btn-success');
            
            // Show notification
            showNotification('success', data.message);
            
            // Reload page after 1 second
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            // Show error
            btn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
            btn.classList.remove('btn-clear-cache');
            btn.classList.add('btn-danger');
            
            showNotification('error', data.error || 'Error al limpiar cache');
            
            // Restore button after 2 seconds
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-clear-cache');
                btn.disabled = false;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        btn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
        btn.classList.remove('btn-clear-cache');
        btn.classList.add('btn-danger');
        
        showNotification('error', 'Error de conexiÃ³n');
        
        // Restore button after 2 seconds
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-clear-cache');
            btn.disabled = false;
        }, 2000);
    });
}

function showNotification(type, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show notification-toast`;
    notification.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    notification.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// ==================== STAT CARD DETAILS MODAL ====================

function showStatDetails(deviceId, statType) {
    // Show loading modal
    const modalHtml = `
        <div class="modal fade" id="statDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            Cargando...
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('statDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('statDetailsModal'));
    modal.show();
    
    // Fetch data
    fetch(`/api/device/${deviceId}/stat/${statType}`)
        .then(response => response.json())
        .then(data => {
            updateModalContent(data, statType);
        })
        .catch(error => {
            console.error('Error:', error);
            updateModalContent({error: 'Error al cargar los datos'}, statType);
        });
}

function updateModalContent(data, statType) {
    const modal = document.getElementById('statDetailsModal');
    const modalContent = modal.querySelector('.modal-content');
    
    if (data.error) {
        modalContent.innerHTML = `
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">${data.error}</div>
            </div>
        `;
        return;
    }
    
    let bodyContent = '';
    
    if (statType === 'total') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Usuario</th>
                            <th>Tipo de Evento</th>
                            <th>CÃ³digo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(event => `
                            <tr>
                                <td><strong>${event.datetime}</strong></td>
                                <td>${event.user}</td>
                                <td>${event.event_type}</td>
                                <td><code>${event.event_code}</code></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (statType === 'granted') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Usuario</th>
                            <th>Puerta</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(event => `
                            <tr>
                                <td><strong>${event.datetime}</strong></td>
                                <td>${event.user}</td>
                                <td>${event.door}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (statType === 'denied') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Usuario</th>
                            <th>RazÃ³n</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(event => `
                            <tr>
                                <td><strong>${event.datetime}</strong></td>
                                <td>${event.user}</td>
                                <td><span class="badge bg-danger">${event.reason}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (statType === 'users') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Total Eventos</th>
                            <th>Concedidos</th>
                            <th>Denegados</th>
                            <th>Ãšltimo Acceso</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(user => `
                            <tr>
                                <td><strong>${user.user_id}</strong></td>
                                <td><span class="badge bg-primary">${user.total_events}</span></td>
                                <td><span class="badge bg-success">${user.granted}</span></td>
                                <td><span class="badge bg-danger">${user.denied}</span></td>
                                <td>${user.last_access}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    modalContent.innerHTML = `
        <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-brown) 0%, var(--medium-brown) 100%); color: white;">
            <div>
                <h5 class="modal-title mb-1">
                    <i class="bi bi-bar-chart-fill"></i> ${data.title}
                </h5>
                <small style="color: var(--accent-cream);">${data.subtitle}</small>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle"></i> 
                <strong>Total:</strong> ${data.count} ${statType === 'users' ? 'usuarios' : 'eventos'}
                ${statType !== 'users' ? '(mostrando Ãºltimos 50)' : '(mostrando top 50)'}
            </div>
            ${bodyContent}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
    `;
}
</script>
{% endblock %}
