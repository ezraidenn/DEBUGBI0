{% extends "base.html" %}

{% block title %}Debug {{ device.name }} - BioStar{% endblock %}

{% block extra_css %}
<style>
.new-event-highlight {
    animation: highlightFade 3s ease-in-out;
    background-color: #d4edda !important;
}

@keyframes highlightFade {
    0% { background-color: #28a745; }
    100% { background-color: transparent; }
}

.realtime-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #dc3545;
    margin-right: 5px;
    animation: pulse 2s infinite;
}

.realtime-indicator.connected {
    background-color: #28a745;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
{% endblock %}

{% block content %}
<!-- Device Header Card -->
<div class="device-header-card mb-3">
    <div class="device-header-info">
        <div class="device-icon">
            <i class="bi bi-fingerprint"></i>
        </div>
        <div class="device-details">
            <h1 class="device-title">
                {% if device.alias %}
                    {{ device.alias }}
                {% else %}
                    {{ device.name }}
                {% endif %}
            </h1>
            <div class="device-meta">
                <span class="device-id"><i class="bi bi-hash"></i> {{ device.id }}</span>
                {% if device.location %}
                <span class="device-location"><i class="bi bi-geo-alt-fill"></i> {{ device.location }}</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Realtime Status Badge -->
<div class="mb-3">
    <span class="badge bg-success" id="realtimeStatus" style="font-size: 14px; padding: 8px 12px;">
        <i class="bi bi-circle-fill" style="font-size: 8px;"></i> Tiempo Real Activo
    </span>
    <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-secondary ms-2">
        <i class="bi bi-arrow-left"></i> Volver al Dashboard
    </a>
</div>

<!-- Summary Cards - Clickeable -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card stat-card-clickable" onclick="showStatDetails({{ device.id }}, 'total')">
            <div class="card-body">
                <h6 class="text-muted">Total Eventos</h6>
                <h2>{{ summary.total_events }}</h2>
                <small class="text-muted">Hoy <i class="bi bi-chevron-right"></i></small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card success stat-card-clickable" onclick="showStatDetails({{ device.id }}, 'granted')">
            <div class="card-body">
                <h6 class="text-muted">Accesos Concedidos</h6>
                <h2>{{ summary.access_granted }}</h2>
                <small class="text-muted">Exitosos <i class="bi bi-chevron-right"></i></small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card danger stat-card-clickable" onclick="showStatDetails({{ device.id }}, 'denied')">
            <div class="card-body">
                <h6 class="text-muted">Accesos Denegados</h6>
                <h2>{{ summary.access_denied }}</h2>
                <small class="text-muted">Rechazados <i class="bi bi-chevron-right"></i></small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card warning stat-card-clickable" onclick="showStatDetails({{ device.id }}, 'users')">
            <div class="card-body">
                <h6 class="text-muted">Usuarios √önicos</h6>
                <h2>{{ summary.unique_users }}</h2>
                <small class="text-muted">Diferentes <i class="bi bi-chevron-right"></i></small>
            </div>
        </div>
    </div>
</div>

{% if summary.first_event %}
<div class="alert alert-info">
    <i class="bi bi-clock"></i> 
    <strong>Primer evento:</strong> {{ summary.first_event.strftime('%H:%M:%S') }} | 
    <strong>√öltimo evento:</strong> {{ summary.last_event.strftime('%H:%M:%S') }}
</div>
{% endif %}

<!-- Events Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Eventos del D√≠a</h5>
    </div>
    <div class="card-body">
        {% if events %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Fecha/Hora</th>
                        <th>Tipo de Evento</th>
                        <th>C√≥digo</th>
                        <th>Usuario</th>
                        <th>Puerta</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                    <tr>
                        <td>
                            {% if event.datetime %}
                                {{ event.datetime.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% set badge_class, event_label = classify_event(event.event_code) %}
                            <span class="badge bg-{{ badge_class }}">{{ event.event_type or event_label }}</span>
                        </td>
                        <td><code>{{ event.event_code }}</code></td>
                        <td>
                            {% if event.user_name %}
                                <strong>{{ event.user_name }}</strong>
                                <br><small class="text-muted">ID: {{ event.user_id }}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if event.door_name %}
                                {{ event.door_name }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i> No hay eventos registrados hoy para este checador.
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const DEVICE_ID = {{ device.id }};
let socket = null;
let isRealtimeEnabled = false;

function exportDebug() {
    fetch('/debug/device/{{ device.id }}/export')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úì ${data.message}\n\nArchivo: ${data.filename}`);
            } else {
                alert(`‚úó Error: ${data.error}`);
            }
        })
        .catch(error => {
            alert('Error al exportar: ' + error);
        });
}

function toggleRealtime() {
    if (isRealtimeEnabled) {
        stopRealtime();
    } else {
        startRealtime();
    }
}

function startRealtime() {
    console.log('‚ö° Iniciando monitoreo en TIEMPO REAL...');
    console.log('üìç Device ID:', DEVICE_ID);
    
    // Connect to WebSocket
    socket = io('/realtime', {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
    });
    
    socket.on('connect', function() {
        console.log('‚úì Conectado al servidor en tiempo real');
        console.log('üì° Socket ID:', socket.id);
        
        // Request monitoring for this device
        console.log('üì§ Enviando solicitud de monitoreo para dispositivo:', DEVICE_ID);
        socket.emit('monitor_device', { device_id: DEVICE_ID });
        
        // Update UI
        isRealtimeEnabled = true;
        const btn = document.getElementById('realtimeBtn');
        const indicator = document.getElementById('realtimeIndicator');
        const btnText = document.getElementById('realtimeBtnText');
        
        btn.classList.remove('btn-success');
        btn.classList.add('btn-danger');
        indicator.classList.add('connected');
        btnText.textContent = 'Detener Tiempo Real';
        
        showNotification('‚ö° Tiempo Real ACTIVADO - Esperando eventos...', 'success');
    });
    
    socket.on('monitoring', function(data) {
        console.log('üìä Estado de monitoreo:', data);
    });
    
    socket.on('new_event', function(data) {
        console.log('üîî NUEVO EVENTO RECIBIDO:', data);
        console.log('   - Device ID:', data.device_id);
        console.log('   - Usuario:', data.user_name);
        console.log('   - Tipo:', data.event_type);
        console.log('   - Fecha:', data.datetime);
        
        if (data.device_id === DEVICE_ID) {
            console.log('‚úÖ Evento es para este dispositivo, procesando...');
            handleNewEvent(data);
        } else {
            console.log('‚ö†Ô∏è Evento es para otro dispositivo, ignorando');
        }
    });
    
    socket.on('disconnect', function() {
        console.log('‚úó Desconectado del servidor');
        const indicator = document.getElementById('realtimeIndicator');
        indicator.classList.remove('connected');
        showNotification('‚ö†Ô∏è Desconectado del servidor', 'warning');
    });
    
    socket.on('connect_error', function(error) {
        console.error('‚ùå Error de conexi√≥n:', error);
        showNotification('‚ùå Error de conexi√≥n WebSocket', 'danger');
    });
    
    socket.on('error', function(error) {
        console.error('‚ùå Error:', error);
    });
}

function stopRealtime() {
    console.log('‚è∏ Deteniendo tiempo real...');
    
    if (socket) {
        socket.emit('stop_monitor_device', { device_id: DEVICE_ID });
        socket.disconnect();
        socket = null;
    }
    
    isRealtimeEnabled = false;
    const btn = document.getElementById('realtimeBtn');
    const indicator = document.getElementById('realtimeIndicator');
    const btnText = document.getElementById('realtimeBtnText');
    
    btn.classList.remove('btn-danger');
    btn.classList.add('btn-success');
    indicator.classList.remove('connected');
    btnText.textContent = 'Activar Tiempo Real';
    
    showNotification('‚è∏ Tiempo Real DETENIDO', 'info');
}

function handleNewEvent(eventData) {
    // Show notification
    const eventType = eventData.event_type || 'Evento';
    const userName = eventData.user_name || 'Desconocido';
    showNotification(`üîî ${eventType}: ${userName}`, 'warning');
    
    // Play sound (optional)
    playNotificationSound();
    
    // Update summary
    updateSummaryRealtime();
    
    // Add event to table (if table exists)
    addEventToTable(eventData);
}

function updateSummaryRealtime() {
    fetch('/api/device/{{ device.id }}/summary')
        .then(response => response.json())
        .then(data => {
            // Update summary cards with animation
            animateNumberChange('.stat-card h2', data.total_events);
            animateNumberChange('.stat-card.success h2', data.access_granted);
            animateNumberChange('.stat-card.danger h2', data.access_denied);
            animateNumberChange('.stat-card.warning h2', data.unique_users);
            
            // Update time info
            if (data.first_event && data.last_event) {
                const timeInfo = document.querySelector('.alert-info');
                if (timeInfo) {
                    timeInfo.innerHTML = `<i class="bi bi-clock"></i> 
                        <strong>Primer evento:</strong> ${data.first_event} | 
                        <strong>√öltimo evento:</strong> ${data.last_event}`;
                }
            }
        });
}

function animateNumberChange(selector, newValue) {
    const elements = document.querySelectorAll(selector);
    if (elements.length > 0) {
        const element = elements[0];
        const oldValue = parseInt(element.textContent);
        if (oldValue !== newValue) {
            element.style.transition = 'all 0.3s ease';
            element.style.transform = 'scale(1.2)';
            element.style.color = '#28a745';
            element.textContent = newValue;
            
            setTimeout(() => {
                element.style.transform = 'scale(1)';
                element.style.color = '';
            }, 300);
        }
    }
}

function addEventToTable(eventData) {
    const tbody = document.querySelector('table tbody');
    if (!tbody) return;
    
    // Create new row
    const row = document.createElement('tr');
    row.classList.add('new-event-highlight');
    
    // Format datetime
    const datetime = new Date(eventData.datetime).toLocaleString('es-MX');
    
    // Determine badge color
    let badgeClass = 'bg-secondary';
    if (eventData.event_code === '4864') badgeClass = 'bg-success';
    else if (eventData.event_code === '4865') badgeClass = 'bg-danger';
    else if (eventData.event_code === '20736') badgeClass = 'bg-warning';
    
    row.innerHTML = `
        <td>${datetime}</td>
        <td><span class="badge ${badgeClass}">${eventData.event_type || 'Evento'}</span></td>
        <td><code>${eventData.event_code}</code></td>
        <td>
            ${eventData.user_name ? `<strong>${eventData.user_name}</strong><br><small class="text-muted">ID: ${eventData.user_id}</small>` : '<span class="text-muted">-</span>'}
        </td>
        <td><span class="text-muted">-</span></td>
    `;
    
    // Insert at the beginning
    tbody.insertBefore(row, tbody.firstChild);
}


// ==================== SSE REALTIME (AUTO-START) ====================

let eventSource = null;
let isRealtimeActive = false;
let eventCount = 0;

function startRealtimeSSE() {
    if (eventSource) {
        console.log('‚ö†Ô∏è SSE ya est√° activo');
        return;
    }
    
    const deviceId = {{ device.id }};
    console.log(`üöÄ Iniciando SSE para dispositivo ${deviceId}`);
    
    // Crear conexi√≥n SSE
    eventSource = new EventSource(`/stream/device/${deviceId}?interval=2`);
    isRealtimeActive = true;
    
    // Update UI
    updateRealtimeUI(true);
    
    // Evento: Conexi√≥n establecida
    eventSource.addEventListener('connection', function(e) {
        const data = JSON.parse(e.data);
        console.log('‚úÖ Conectado a SSE:', data);
    });
    
    // Evento: Nuevo evento
    eventSource.addEventListener('new_event', function(e) {
        const event = JSON.parse(e.data);
        console.log('üì• Nuevo evento:', event);
        
        // Agregar evento a la tabla
        addEventToTable(event);
        
        // Actualizar contadores
        updateCounters(event);
        
        eventCount++;
    });
    
    // Evento: Heartbeat
    eventSource.addEventListener('heartbeat', function(e) {
        console.log('üíì Heartbeat recibido');
    });
    
    // Evento: Error
    eventSource.addEventListener('error', function(e) {
        const data = e.data ? JSON.parse(e.data) : {};
        console.error('‚ùå Error SSE:', data);
    });
    
    // Error de conexi√≥n
    eventSource.onerror = function(e) {
        console.error('‚ùå Error de conexi√≥n SSE:', e);
        
        if (eventSource.readyState === EventSource.CLOSED) {
            console.log('üîå Conexi√≥n cerrada, reintentando en 5s...');
            stopRealtimeSSE();
            
            setTimeout(() => {
                if (!isRealtimeActive) {
                    startRealtimeSSE();
                }
            }, 5000);
        }
    };
}

function stopRealtimeSSE() {
    if (eventSource) {
        eventSource.close();
        eventSource = null;
        isRealtimeActive = false;
        updateRealtimeUI(false);
        console.log('üõë SSE detenido');
    }
}

function toggleRealtime() {
    if (isRealtimeActive) {
        stopRealtimeSSE();
        showNotification('info', '<i class="bi bi-pause-circle"></i> Monitoreo en tiempo real pausado');
    } else {
        startRealtimeSSE();
    }
}

function updateRealtimeUI(active) {
    const btn = document.getElementById('realtimeBtn');
    const indicator = document.getElementById('realtimeIndicator');
    const btnText = document.getElementById('realtimeBtnText');
    const statusBadge = document.getElementById('realtimeStatus');
    const eventCounter = document.getElementById('eventCounter');
    
    if (active) {
        indicator.classList.add('connected');
        btnText.textContent = 'Tiempo Real Activo';
        btn.classList.add('active');
        if (statusBadge) statusBadge.style.display = 'block';
    } else {
        indicator.classList.remove('connected');
        btnText.textContent = 'Activar Tiempo Real';
        btn.classList.remove('active');
        if (statusBadge) statusBadge.style.display = 'none';
    }
    
    if (eventCounter) {
        eventCounter.textContent = `${eventCount} eventos recibidos`;
    }
}

function addEventToTable(event) {
    // Buscar tbody - la tabla est√° dentro de .table-responsive
    const tbody = document.querySelector('.table-responsive tbody');
    if (!tbody) {
        console.error('‚ö†Ô∏è No se encontr√≥ tbody de la tabla de eventos');
        console.log('Tablas disponibles:', document.querySelectorAll('tbody'));
        return;
    }
    
    // Verificar si el evento ya existe (evitar duplicados)
    const existingRows = tbody.querySelectorAll('tr');
    for (let row of existingRows) {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 3) {
            const existingCode = cells[2].textContent.trim();
            const existingTime = cells[0].textContent.trim();
            const newCode = event.event_code || '';
            const newTime = event.datetime_full ? new Date(event.datetime_full).toLocaleString('es-MX').replace(',', '') : '';
            
            if (existingCode === newCode && existingTime.includes(newTime.split(' ')[1])) {
                console.log('‚è≠Ô∏è Evento ya existe, saltando:', event.id);
                return;
            }
        }
    }
    
    console.log('‚ûï Agregando evento a tabla:', event);
    
    // Crear nueva fila
    const row = document.createElement('tr');
    row.className = 'new-event-highlight';
    
    // Formatear fecha/hora en formato YYYY-MM-DD HH:MM:SS
    let dateTimeStr = '-';
    if (event.datetime_full) {
        const dt = new Date(event.datetime_full);
        const year = dt.getFullYear();
        const month = String(dt.getMonth() + 1).padStart(2, '0');
        const day = String(dt.getDate()).padStart(2, '0');
        const hours = String(dt.getHours()).padStart(2, '0');
        const minutes = String(dt.getMinutes()).padStart(2, '0');
        const seconds = String(dt.getSeconds()).padStart(2, '0');
        dateTimeStr = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    } else if (event.datetime) {
        dateTimeStr = event.datetime;
    }
    
    // Usar badge_class y event_label del servidor (misma l√≥gica que la tabla original)
    const badgeClass = event.badge_class || 'secondary';
    const eventLabel = event.event_label || event.event_type || 'Otro Evento';
    const eventBadge = `<span class="badge bg-${badgeClass}">${eventLabel}</span>`;
    
    // Formatear usuario (nombre + ID)
    let userHtml = '<span class="text-muted">-</span>';
    if (event.user && event.user !== 'Desconocido') {
        userHtml = `<strong>${event.user}</strong>`;
        if (event.user_id) {
            userHtml += `<br><small class="text-muted">ID: ${event.user_id}</small>`;
        }
    }
    
    // Formatear c√≥digo
    let codeHtml = event.event_code ? `<code>${event.event_code}</code>` : '-';
    
    // Formatear puerta
    let doorHtml = event.door || '-';
    
    // Orden de columnas: Fecha/Hora | Tipo de Evento | C√≥digo | Usuario | Puerta
    row.innerHTML = `
        <td>${dateTimeStr}</td>
        <td>${eventBadge}</td>
        <td>${codeHtml}</td>
        <td>${userHtml}</td>
        <td>${doorHtml}</td>
    `;
    
    // Insertar al inicio de la tabla
    tbody.insertBefore(row, tbody.firstChild);
    console.log('‚úÖ Evento agregado a la tabla');
    
    // Limitar a 100 filas
    while (tbody.children.length > 100) {
        tbody.removeChild(tbody.lastChild);
    }
    
    // Remover highlight despu√©s de 3 segundos
    setTimeout(() => {
        row.classList.remove('new-event-highlight');
    }, 3000);
    
    // Actualizar contador de eventos recibidos
    eventCount++;
    updateRealtimeUI(true);
}

function updateCounters(event) {
    // Actualizar contador total
    const totalCard = document.querySelector('.stat-card h2');
    if (totalCard) {
        const current = parseInt(totalCard.textContent) || 0;
        totalCard.textContent = current + 1;
    }
    
    // Actualizar contador de concedidos/denegados
    if (event.is_granted) {
        const grantedCard = document.querySelectorAll('.stat-card.success h2')[0];
        if (grantedCard) {
            const current = parseInt(grantedCard.textContent) || 0;
            grantedCard.textContent = current + 1;
        }
    } else if (event.is_denied) {
        const deniedCard = document.querySelectorAll('.stat-card.danger h2')[0];
        if (deniedCard) {
            const current = parseInt(deniedCard.textContent) || 0;
            deniedCard.textContent = current + 1;
        }
    }
}

// Auto-start realtime on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ P√°gina cargada - Iniciando tiempo real autom√°tico');
    
    // Iniciar SSE autom√°ticamente
    setTimeout(() => {
        startRealtimeSSE();
    }, 500);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopRealtimeSSE();
});

// ==================== CLEAR CACHE AND RELOAD ====================

function clearCacheAndReload() {
    const deviceId = {{ device.id }};
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Limpiando...';
    
    // Call API to clear cache
    fetch(`/debug/device/${deviceId}/clear-cache`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Cache limpiado';
            btn.classList.remove('btn-clear-cache');
            btn.classList.add('btn-success');
            
            
            // Reload page after 1 second
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            // Show error
            btn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
            btn.classList.remove('btn-clear-cache');
            btn.classList.add('btn-danger');
            
            // Restore button after 2 seconds
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-clear-cache');
                btn.disabled = false;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        btn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
        btn.classList.remove('btn-clear-cache');
        btn.classList.add('btn-danger');
        
        showNotification('error', 'Error de conexi√≥n');
        
        // Restore button after 2 seconds
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-clear-cache');
            btn.disabled = false;
        }, 2000);
    });
}

function showNotification(type, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show notification-toast`;
    notification.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    notification.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// ==================== STAT CARD DETAILS MODAL ====================

function showStatDetails(deviceId, statType) {
    // Show loading modal
    const modalHtml = `
        <div class="modal fade" id="statDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            Cargando...
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('statDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('statDetailsModal'));
    modal.show();
    
    // Fetch data
    fetch(`/api/device/${deviceId}/stat/${statType}`)
        .then(response => response.json())
        .then(data => {
            updateModalContent(data, statType);
        })
        .catch(error => {
            console.error('Error:', error);
            updateModalContent({error: 'Error al cargar los datos'}, statType);
        });
}

function updateModalContent(data, statType) {
    const modal = document.getElementById('statDetailsModal');
    const modalContent = modal.querySelector('.modal-content');
    
    if (data.error) {
        modalContent.innerHTML = `
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">${data.error}</div>
            </div>
        `;
        return;
    }
    
    let bodyContent = '';
    
    if (statType === 'total') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Usuario</th>
                            <th>Tipo de Evento</th>
                            <th>C√≥digo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(event => `
                            <tr>
                                <td><strong>${event.datetime}</strong></td>
                                <td>${event.user}</td>
                                <td>${event.event_type}</td>
                                <td><code>${event.event_code}</code></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (statType === 'granted') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Usuario</th>
                            <th>Puerta</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(event => `
                            <tr>
                                <td><strong>${event.datetime}</strong></td>
                                <td>${event.user}</td>
                                <td>${event.door}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (statType === 'denied') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Usuario</th>
                            <th>Raz√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(event => `
                            <tr>
                                <td><strong>${event.datetime}</strong></td>
                                <td>${event.user}</td>
                                <td><span class="badge bg-danger">${event.reason}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (statType === 'users') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Total Eventos</th>
                            <th>Concedidos</th>
                            <th>Denegados</th>
                            <th>√öltimo Acceso</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(user => `
                            <tr>
                                <td><strong>${user.user_id}</strong></td>
                                <td><span class="badge bg-primary">${user.total_events}</span></td>
                                <td><span class="badge bg-success">${user.granted}</span></td>
                                <td><span class="badge bg-danger">${user.denied}</span></td>
                                <td>${user.last_access}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    modalContent.innerHTML = `
        <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-brown) 0%, var(--medium-brown) 100%); color: white;">
            <div>
                <h5 class="modal-title mb-1">
                    <i class="bi bi-bar-chart-fill"></i> ${data.title}
                </h5>
                <small style="color: var(--accent-cream);">${data.subtitle}</small>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle"></i> 
                <strong>Total:</strong> ${data.count} ${statType === 'users' ? 'usuarios' : 'eventos'}
                ${statType !== 'users' ? '(mostrando √∫ltimos 50)' : '(mostrando top 50)'}
            </div>
            ${bodyContent}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
    `;
}
</script>
{% endblock %}
