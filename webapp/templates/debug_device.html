{% extends "base.html" %}

{% block title %}Logs {{ device.name }} - BioStar{% endblock %}

{% block extra_css %}
<style>
.new-event-highlight {
    animation: highlightFade 3s ease-in-out;
    background-color: #d4edda !important;
}

@keyframes highlightFade {
    0% { background-color: #28a745; }
    100% { background-color: transparent; }
}

.realtime-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #dc3545;
    margin-right: 5px;
    animation: pulse 2s infinite;
}

.realtime-indicator.connected {
    background-color: #28a745;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
{% endblock %}

{% block content %}
<!-- Device Header Card -->
<div class="device-header-card mb-3">
    <div class="device-header-info">
        <div class="device-icon">
            <i class="bi bi-fingerprint"></i>
        </div>
        <div class="device-details">
            <h1 class="device-title">
                {% if device.alias %}
                    {{ device.alias }}
                {% else %}
                    {{ device.name }}
                {% endif %}
            </h1>
            <div class="device-meta">
                <span class="device-id"><i class="bi bi-hash"></i> {{ device.id }}</span>
                {% if device.location %}
                <span class="device-location"><i class="bi bi-geo-alt-fill"></i> {{ device.location }}</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Realtime Status Badge & Back Button -->
<div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <span class="badge bg-success" id="realtimeStatus" style="font-size: 12px; padding: 6px 10px;">
        <i class="bi bi-circle-fill" style="font-size: 6px;"></i> Tiempo Real
    </span>
    <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-secondary">
        <i class="bi bi-arrow-left"></i> <span class="hide-mobile">Volver</span>
    </a>
</div>

<!-- Summary Cards -->
<div class="row mb-3 mb-md-4">
    <div class="col-6 col-md-3 mb-2">
        <div class="stat-card success">
            <h6>Accesos</h6>
            <h2 id="statTotal">{{ summary.total_events }}</h2>
            <small>Concedidos hoy</small>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
        <div class="stat-card">
            <h6>Usuarios</h6>
            <h2 id="statUsers">{{ summary.unique_users }}</h2>
            <small>√önicos</small>
        </div>
    </div>
    {% if is_checador and pairs_data %}
    <div class="col-6 col-md-3 mb-2">
        <div class="stat-card warning" style="cursor: pointer;" onclick="togglePendingList()">
            <h6>No han salido</h6>
            <h2 id="statPending">{{ pairs_data.pending|length }}</h2>
            <small>Ver lista <i class="bi bi-chevron-right"></i></small>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
        <div class="stat-card" style="background: #e8f5e9;">
            <h6>Completos</h6>
            <h2 id="statComplete">{{ pairs_data.complete|length }}</h2>
            <small>Entrada + Salida</small>
        </div>
    </div>
    {% endif %}
</div>

{% if summary.first_event %}
<div class="alert alert-info mb-3">
    <i class="bi bi-clock"></i> 
    <strong>Primer acceso:</strong> {{ summary.first_event.strftime('%H:%M:%S') }} 
    <span class="hide-mobile">|</span>
    <br class="hide-desktop">
    <strong>√öltimo:</strong> {{ summary.last_event.strftime('%H:%M:%S') }}
</div>
{% endif %}

<!-- Pending Users (No han salido) - Solo para Checadores -->
{% if is_checador and pairs_data and pairs_data.pending %}
<div class="card mb-3" id="pendingCard" style="display: none; border-left: 4px solid #ff9800;">
    <div class="card-header bg-warning bg-opacity-25">
        <h5 class="mb-0">
            <i class="bi bi-exclamation-triangle"></i> 
            Usuarios que NO han salido ({{ pairs_data.pending|length }})
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="pending-list">
            {% for user in pairs_data.pending %}
            <div class="pending-item">
                <div class="pending-user">
                    <i class="bi bi-person-fill"></i>
                    <strong>{{ user.user_name }}</strong>
                    <small class="text-muted">#{{ user.user_id }}</small>
                </div>
                <div class="pending-time">
                    <i class="bi bi-box-arrow-in-right text-success"></i>
                    Entrada: {{ user.first_event.strftime('%H:%M:%S') if user.first_event else '-' }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Events Section -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Eventos del D√≠a</h5>
    </div>
    <div class="card-body p-0 p-md-3">
        {% if events %}
        
        <!-- Desktop: Tabla normal -->
        <div class="table-responsive hide-mobile">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Tipo</th>
                        <th>C√≥digo</th>
                        <th>Usuario</th>
                        <th>Puerta</th>
                    </tr>
                </thead>
                <tbody id="eventsTableBody">
                    {% for event in events %}
                    <tr>
                        <td>
                            {% if event.datetime %}
                                {{ event.datetime.strftime('%H:%M:%S') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% set badge_class, event_label = classify_event(event.event_code) %}
                            <span class="badge bg-{{ badge_class }}">{{ event.event_type or event_label }}</span>
                        </td>
                        <td><code>{{ event.event_code }}</code></td>
                        <td>
                            {% if event.user_name %}
                                <strong>{{ event.user_name }}</strong>
                                <br><small class="text-muted">ID: {{ event.user_id }}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ event.door_name or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Mobile: Lista de Cards -->
        <div class="event-list hide-desktop" id="eventsListMobile">
            {% for event in events %}
            {% set badge_class, event_label = classify_event(event.event_code) %}
            <div class="event-item {% if badge_class == 'success' %}access-granted{% elif badge_class == 'danger' %}access-denied{% elif badge_class == 'warning' %}door-event{% endif %}">
                <div class="event-item-header">
                    <span class="event-time">
                        <i class="bi bi-clock"></i>
                        {% if event.datetime %}
                            {{ event.datetime.strftime('%H:%M:%S') }}
                        {% else %}
                            --:--:--
                        {% endif %}
                    </span>
                    <span class="badge bg-{{ badge_class }}">{{ event.event_type or event_label }}</span>
                </div>
                {% if event.user_name or event.door_name %}
                <div class="event-item-body">
                    {% if event.user_name %}
                    <div class="event-user">
                        <i class="bi bi-person-fill"></i>
                        <span>{{ event.user_name }}</span>
                        <small>#{{ event.user_id }}</small>
                    </div>
                    {% endif %}
                    {% if event.door_name %}
                    <div class="event-door">
                        <i class="bi bi-door-open"></i>
                        <span>{{ event.door_name }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        {% else %}
        <div class="alert alert-info mb-0 m-3">
            <i class="bi bi-info-circle"></i> No hay eventos registrados hoy.
        </div>
        {% endif %}
    </div>
</div>

<script>
// ==================== TOGGLE PENDING LIST ====================

function togglePendingList() {
    const card = document.getElementById('pendingCard');
    if (card) {
        if (card.style.display === 'none') {
            card.style.display = 'block';
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            card.style.display = 'none';
        }
    }
}

// ==================== SSE REALTIME (AUTO-START) ====================

let eventSource = null;
let isRealtimeActive = false;
let eventCount = 0;
let reconnectAttempts = 0;
let maxReconnectAttempts = 999; // Intentos infinitos
let reconnectDelay = 3000; // 3 segundos
let lastHeartbeat = Date.now();
let heartbeatCheckInterval = null;

function startRealtimeSSE() {
    if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
        console.log('‚ö†Ô∏è SSE ya est√° activo');
        return;
    }
    
    const deviceId = {{ device.id }};
    console.log(`üöÄ Iniciando SSE para dispositivo: ${deviceId} (intento ${reconnectAttempts + 1})`);
    
    // Cerrar conexi√≥n anterior si existe
    if (eventSource) {
        eventSource.close();
    }
    
    eventSource = new EventSource(`/stream/device/${deviceId}?interval=2`);
    isRealtimeActive = true;
    lastHeartbeat = Date.now();
    
    // Update UI
    updateRealtimeUI(true);
    
    // Iniciar verificaci√≥n de heartbeat
    startHeartbeatCheck();
    
    // Evento: Conexi√≥n establecida
    eventSource.addEventListener('connection', function(e) {
        const data = JSON.parse(e.data);
        console.log('‚úÖ Conectado a SSE:', data);
        reconnectAttempts = 0; // Reset intentos al conectar exitosamente
        lastHeartbeat = Date.now();
    });
    
    // Evento: Nuevo evento
    eventSource.addEventListener('new_event', function(e) {
        const event = JSON.parse(e.data);
        console.log('üì• Nuevo evento:', event);
        lastHeartbeat = Date.now();
        
        // Agregar evento a la tabla
        addEventToTable(event);
        
        // Actualizar contadores
        updateCounters(event);
        
        eventCount++;
    });
    
    // Evento: Heartbeat
    eventSource.addEventListener('heartbeat', function(e) {
        console.log('üíì Heartbeat recibido');
        lastHeartbeat = Date.now();
    });
    
    // Evento: Error
    eventSource.addEventListener('error', function(e) {
        console.error('‚ùå Error en SSE:', e);
        
        if (eventSource.readyState === EventSource.CLOSED) {
            console.log('üîÑ Conexi√≥n cerrada, reconectando...');
            attemptReconnect();
        }
    });
    
    // Detectar cuando la pesta√±a vuelve a estar activa
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && eventSource && eventSource.readyState === EventSource.CLOSED) {
            console.log('üëÅÔ∏è Pesta√±a activa de nuevo, reconectando...');
            attemptReconnect();
        }
    });
}

function startHeartbeatCheck() {
    // Limpiar intervalo anterior
    if (heartbeatCheckInterval) {
        clearInterval(heartbeatCheckInterval);
    }
    
    // Verificar heartbeat cada 30 segundos
    heartbeatCheckInterval = setInterval(function() {
        const timeSinceLastHeartbeat = Date.now() - lastHeartbeat;
        
        // Si no hay heartbeat en 45 segundos, reconectar
        if (timeSinceLastHeartbeat > 45000) {
            console.warn(`‚ö†Ô∏è Sin heartbeat por ${Math.floor(timeSinceLastHeartbeat / 1000)}s, reconectando...`);
            attemptReconnect();
        }
    }, 30000);
}

function attemptReconnect() {
    if (reconnectAttempts >= maxReconnectAttempts) {
        console.error('‚ùå M√°ximo de intentos de reconexi√≥n alcanzado');
        stopRealtimeSSE();
        return;
    }
    
    reconnectAttempts++;
    stopRealtimeSSE();
    
    const delay = Math.min(reconnectDelay * reconnectAttempts, 30000); // Max 30 segundos
    console.log(`‚è≥ Reconectando en ${delay / 1000}s...`);
    
    setTimeout(function() {
        startRealtimeSSE();
    }, delay);
}

function stopRealtimeSSE() {
    if (eventSource) {
        eventSource.close();
        eventSource = null;
        isRealtimeActive = false;
        updateRealtimeUI(false);
        console.log('üõë SSE detenido');
    }
}

function toggleRealtime() {
    if (isRealtimeActive) {
        stopRealtimeSSE();
        showNotification('info', '<i class="bi bi-pause-circle"></i> Monitoreo en tiempo real pausado');
    } else {
        startRealtimeSSE();
    }
}

function updateRealtimeUI(active) {
    const statusBadge = document.getElementById('realtimeStatus');
    
    if (statusBadge) {
        if (active) {
            statusBadge.classList.remove('bg-warning', 'bg-danger');
            statusBadge.classList.add('bg-success');
            statusBadge.innerHTML = '<i class="bi bi-circle-fill" style="font-size: 8px;"></i> Tiempo Real Activo';
        } else {
            statusBadge.classList.remove('bg-success', 'bg-warning');
            statusBadge.classList.add('bg-danger');
            statusBadge.innerHTML = '<i class="bi bi-circle-fill" style="font-size: 8px;"></i> Desconectado';
        }
    }
}

function addEventToTable(event) {
    // Buscar tbody - la tabla est√° dentro de .table-responsive
    const tbody = document.querySelector('.table-responsive tbody');
    if (!tbody) {
        console.error('‚ö†Ô∏è No se encontr√≥ tbody de la tabla de eventos');
        console.log('Tablas disponibles:', document.querySelectorAll('tbody'));
        return;
    }
    
    // Verificar si el evento ya existe (evitar duplicados)
    const existingRows = tbody.querySelectorAll('tr');
    for (let row of existingRows) {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 3) {
            const existingCode = cells[2].textContent.trim();
            const existingTime = cells[0].textContent.trim();
            const newCode = event.event_code || '';
            const newTime = event.datetime_full ? new Date(event.datetime_full).toLocaleString('es-MX').replace(',', '') : '';
            
            if (existingCode === newCode && existingTime.includes(newTime.split(' ')[1])) {
                console.log('‚è≠Ô∏è Evento ya existe, saltando:', event.id);
                return;
            }
        }
    }
    
    console.log('‚ûï Agregando evento a tabla:', event);
    
    // Crear nueva fila
    const row = document.createElement('tr');
    row.className = 'new-event-highlight';
    
    // Formatear fecha/hora en formato YYYY-MM-DD HH:MM:SS
    let dateTimeStr = '-';
    if (event.datetime_full) {
        const dt = new Date(event.datetime_full);
        const year = dt.getFullYear();
        const month = String(dt.getMonth() + 1).padStart(2, '0');
        const day = String(dt.getDate()).padStart(2, '0');
        const hours = String(dt.getHours()).padStart(2, '0');
        const minutes = String(dt.getMinutes()).padStart(2, '0');
        const seconds = String(dt.getSeconds()).padStart(2, '0');
        dateTimeStr = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    } else if (event.datetime) {
        dateTimeStr = event.datetime;
    }
    
    // Usar badge_class y event_label del servidor (misma l√≥gica que la tabla original)
    const badgeClass = event.badge_class || 'secondary';
    const eventLabel = event.event_label || event.event_type || 'Otro Evento';
    const eventBadge = `<span class="badge bg-${badgeClass}">${eventLabel}</span>`;
    
    // Formatear usuario (nombre + ID)
    let userHtml = '<span class="text-muted">-</span>';
    if (event.user && event.user !== 'Desconocido') {
        userHtml = `<strong>${event.user}</strong>`;
        if (event.user_id) {
            userHtml += `<br><small class="text-muted">ID: ${event.user_id}</small>`;
        }
    }
    
    // Formatear c√≥digo
    let codeHtml = event.event_code ? `<code>${event.event_code}</code>` : '-';
    
    // Formatear puerta
    let doorHtml = event.door || '-';
    
    // Orden de columnas: Fecha/Hora | Tipo de Evento | C√≥digo | Usuario | Puerta
    row.innerHTML = `
        <td>${dateTimeStr}</td>
        <td>${eventBadge}</td>
        <td>${codeHtml}</td>
        <td>${userHtml}</td>
        <td>${doorHtml}</td>
    `;
    
    // Insertar al inicio de la tabla
    tbody.insertBefore(row, tbody.firstChild);
    console.log('‚úÖ Evento agregado a la tabla');
    
    // Limitar a 100 filas
    while (tbody.children.length > 100) {
        tbody.removeChild(tbody.lastChild);
    }
    
    // Remover highlight despu√©s de 3 segundos
    setTimeout(() => {
        row.classList.remove('new-event-highlight');
    }, 3000);
    
    // Actualizar contador de eventos recibidos
    eventCount++;
    updateRealtimeUI(true);
}

function updateCounters(event) {
    // Actualizar contador total
    const totalCard = document.querySelector('.stat-card h2');
    if (totalCard) {
        const current = parseInt(totalCard.textContent) || 0;
        totalCard.textContent = current + 1;
    }
    
    // Actualizar contador de concedidos/denegados
    if (event.is_granted) {
        const grantedCard = document.querySelectorAll('.stat-card.success h2')[0];
        if (grantedCard) {
            const current = parseInt(grantedCard.textContent) || 0;
            grantedCard.textContent = current + 1;
        }
    } else if (event.is_denied) {
        const deniedCard = document.querySelectorAll('.stat-card.danger h2')[0];
        if (deniedCard) {
            const current = parseInt(deniedCard.textContent) || 0;
            deniedCard.textContent = current + 1;
        }
    }
}

// Auto-start realtime on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ P√°gina cargada - Iniciando tiempo real autom√°tico');
    
    // Iniciar SSE autom√°ticamente
    setTimeout(() => {
        startRealtimeSSE();
    }, 500);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopRealtimeSSE();
});

// ==================== CLEAR CACHE AND RELOAD ====================

function clearCacheAndReload() {
    const deviceId = {{ device.id }};
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Limpiando...';
    
    // Call API to clear cache
    fetch(`/debug/device/${deviceId}/clear-cache`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Cache limpiado';
            btn.classList.remove('btn-clear-cache');
            btn.classList.add('btn-success');
            
            
            // Reload page after 1 second
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            // Show error
            btn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
            btn.classList.remove('btn-clear-cache');
            btn.classList.add('btn-danger');
            
            // Restore button after 2 seconds
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-clear-cache');
                btn.disabled = false;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        btn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
        btn.classList.remove('btn-clear-cache');
        btn.classList.add('btn-danger');
        
        showNotification('error', 'Error de conexi√≥n');
        
        // Restore button after 2 seconds
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-clear-cache');
            btn.disabled = false;
        }, 2000);
    });
}

function showNotification(type, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show notification-toast`;
    notification.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    notification.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// ==================== STAT CARD DETAILS MODAL ====================

function showStatDetails(deviceId, statType) {
    // Show loading modal
    const modalHtml = `
        <div class="modal fade" id="statDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            Cargando...
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('statDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('statDetailsModal'));
    modal.show();
    
    // Fetch data
    fetch(`/api/device/${deviceId}/stat/${statType}`)
        .then(response => response.json())
        .then(data => {
            updateModalContent(data, statType);
        })
        .catch(error => {
            console.error('Error:', error);
            updateModalContent({error: 'Error al cargar los datos'}, statType);
        });
}

function updateModalContent(data, statType) {
    const modal = document.getElementById('statDetailsModal');
    const modalContent = modal.querySelector('.modal-content');
    
    if (data.error) {
        modalContent.innerHTML = `
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">${data.error}</div>
            </div>
        `;
        return;
    }
    
    let bodyContent = '';
    
    if (statType === 'total') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Usuario</th>
                            <th>Tipo de Evento</th>
                            <th>C√≥digo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(event => `
                            <tr>
                                <td><strong>${event.datetime}</strong></td>
                                <td>${event.user}</td>
                                <td>${event.event_type}</td>
                                <td><code>${event.event_code}</code></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (statType === 'granted') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Usuario</th>
                            <th>Puerta</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(event => `
                            <tr>
                                <td><strong>${event.datetime}</strong></td>
                                <td>${event.user}</td>
                                <td>${event.door}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (statType === 'denied') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Usuario</th>
                            <th>Raz√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(event => `
                            <tr>
                                <td><strong>${event.datetime}</strong></td>
                                <td>${event.user}</td>
                                <td><span class="badge bg-danger">${event.reason}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (statType === 'users') {
        bodyContent = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Total Eventos</th>
                            <th>Concedidos</th>
                            <th>Denegados</th>
                            <th>√öltimo Acceso</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(user => `
                            <tr>
                                <td><strong>${user.user_id}</strong></td>
                                <td><span class="badge bg-primary">${user.total_events}</span></td>
                                <td><span class="badge bg-success">${user.granted}</span></td>
                                <td><span class="badge bg-danger">${user.denied}</span></td>
                                <td>${user.last_access}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    modalContent.innerHTML = `
        <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-brown) 0%, var(--medium-brown) 100%); color: white;">
            <div>
                <h5 class="modal-title mb-1">
                    <i class="bi bi-bar-chart-fill"></i> ${data.title}
                </h5>
                <small style="color: var(--accent-cream);">${data.subtitle}</small>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle"></i> 
                <strong>Total:</strong> ${data.count} ${statType === 'users' ? 'usuarios' : 'eventos'}
                ${statType !== 'users' ? '(mostrando √∫ltimos 50)' : '(mostrando top 50)'}
            </div>
            ${bodyContent}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
    `;
}
</script>
{% endblock %}
