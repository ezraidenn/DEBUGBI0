{% extends "base.html" %}

{% block title %}Debug General - BioStar{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="bi bi-bug"></i> Debug General</h2>
    <div class="page-header-actions">
        <button class="btn btn-success btn-sm" onclick="exportAll()">
            <i class="bi bi-file-earmark-excel"></i> <span class="hide-mobile">Exportar</span>
        </button>
        <button class="btn btn-primary btn-sm" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise"></i> <span class="hide-mobile">Actualizar</span>
        </button>
    </div>
</div>

<!-- Desktop: Tabla -->
<div class="card hide-mobile">
    <div class="card-body p-0 p-md-3">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Checador</th>
                        <th>Ubicación</th>
                        <th class="text-center">Total</th>
                        <th class="text-center">Ok</th>
                        <th class="text-center">No</th>
                        <th class="text-center">Usuarios</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in summaries %}
                    <tr>
                        <td>
                            <strong>
                                {% if item.device.alias %}
                                    {{ item.device.alias }}
                                {% else %}
                                    {{ item.device.name }}
                                {% endif %}
                            </strong>
                            <br><small class="text-muted">ID: {{ item.device.id }}</small>
                        </td>
                        <td>{{ item.device.location or '-' }}</td>
                        <td class="text-center">
                            <span class="badge bg-primary">{{ item.summary.total_events }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-success">{{ item.summary.access_granted }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-danger">{{ item.summary.access_denied }}</span>
                        </td>
                        <td class="text-center">{{ item.summary.unique_users }}</td>
                        <td class="text-center">
                            <a href="{{ url_for('debug_device', device_id=item.device.id) }}" 
                               class="btn btn-sm btn-primary" title="Ver">
                                <i class="bi bi-eye"></i> Ver
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <td colspan="2"><strong>TOTAL</strong></td>
                        <td class="text-center"><strong>{{ summaries|sum(attribute='summary.total_events') }}</strong></td>
                        <td class="text-center"><strong>{{ summaries|sum(attribute='summary.access_granted') }}</strong></td>
                        <td class="text-center"><strong>{{ summaries|sum(attribute='summary.access_denied') }}</strong></td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Mobile: Lista de Cards -->
<div class="device-summary-list hide-desktop">
    {% for item in summaries %}
    <div class="device-summary-card">
        <div class="device-summary-header">
            <div class="device-summary-name">
                <strong>
                    {% if item.device.alias %}
                        {{ item.device.alias }}
                    {% else %}
                        {{ item.device.name }}
                    {% endif %}
                </strong>
                <small class="text-muted">ID: {{ item.device.id }}</small>
            </div>
            <a href="{{ url_for('debug_device', device_id=item.device.id) }}" class="btn btn-sm btn-primary">
                <i class="bi bi-eye"></i>
            </a>
        </div>
        <div class="device-summary-stats">
            <div class="stat-item">
                <span class="badge bg-primary">{{ item.summary.total_events }}</span>
                <span class="stat-label">Total</span>
            </div>
            <div class="stat-item">
                <span class="badge bg-success">{{ item.summary.access_granted }}</span>
                <span class="stat-label">Ok</span>
            </div>
            <div class="stat-item">
                <span class="badge bg-danger">{{ item.summary.access_denied }}</span>
                <span class="stat-label">No</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ item.summary.unique_users }}</span>
                <span class="stat-label">Usuarios</span>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Totales en móvil -->
    <div class="device-summary-card total-card">
        <div class="device-summary-header">
            <strong>TOTALES</strong>
        </div>
        <div class="device-summary-stats">
            <div class="stat-item">
                <span class="badge bg-primary">{{ summaries|sum(attribute='summary.total_events') }}</span>
                <span class="stat-label">Total</span>
            </div>
            <div class="stat-item">
                <span class="badge bg-success">{{ summaries|sum(attribute='summary.access_granted') }}</span>
                <span class="stat-label">Ok</span>
            </div>
            <div class="stat-item">
                <span class="badge bg-danger">{{ summaries|sum(attribute='summary.access_denied') }}</span>
                <span class="stat-label">No</span>
            </div>
        </div>
    </div>
</div>

<script>
function exportDevice(deviceId) {
    fetch(`/debug/device/${deviceId}/export`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`✓ ${data.message}\nArchivo: ${data.filename}`);
            } else {
                alert(`✗ Error: ${data.error}`);
            }
        })
        .catch(error => {
            alert('Error al exportar: ' + error);
        });
}

function exportAll() {
    if (!confirm('¿Exportar debug de todos los checadores?')) return;
    
    const devices = {{ summaries|map(attribute='device.id')|list|tojson }};
    let completed = 0;
    
    devices.forEach(deviceId => {
        fetch(`/debug/device/${deviceId}/export`)
            .then(response => response.json())
            .then(data => {
                completed++;
                if (completed === devices.length) {
                    alert(`✓ Exportación completada: ${devices.length} archivos generados`);
                }
            });
    });
}
</script>
{% endblock %}
