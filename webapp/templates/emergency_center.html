{% extends "base.html" %}

{% block title %}Centro de Emergencias{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Alertas de emergencias activas -->
    <div id="active-emergencies-alert" style="display: none;">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> ¬°EMERGENCIA ACTIVA!</h5>
            <div id="active-emergencies-list"></div>
        </div>
    </div>

    <!-- Selector de zona -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3"><i class="bi bi-building"></i> Selecciona una zona</h5>
                    <div id="zones-container" class="row">
                        <div class="col-12 text-center py-4">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2">Cargando zonas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n de emergencia (aparece al seleccionar zona) -->
    <div id="emergency-button-section" style="display: none;">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-danger">
                    <div class="card-body text-center py-5">
                        <h3 class="mb-4">Zona: <span id="selected-zone-display"></span></h3>
                        <button id="activateEmergencyBtn" class="btn btn-danger btn-lg px-5 py-3" onclick="activateEmergency()">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <span style="font-size: 1.5rem; display: block; margin-top: 10px;">
                                ACTIVAR EMERGENCIA
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pase de lista (aparece cuando hay emergencia activa) -->
    <div id="roll-call-section" style="display: none;">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-white d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #3E2723 0%, #5D4037 100%);">
                        <h5 class="mb-0">
                            <i class="bi bi-clipboard-check"></i> Pase de Lista en Tiempo Real
                        </h5>
                        <div class="btn-group">
                            <a id="exportExcelBtn" href="#" class="btn btn-sm" download style="display: none; background: #4CAF50; color: white; border: none;">
                                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                            </a>
                            <a href="/emergency/history" class="btn btn-sm" style="background: #6D4C41; color: white; border: none;">
                                <i class="bi bi-clock-history"></i> Historial
                            </a>
                            <button class="btn btn-sm" onclick="resolveEmergency()" style="background: #D7CCC8; color: #3E2723; border: none;">
                                <i class="bi bi-check-circle"></i> Resolver Emergencia
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Estad√≠sticas -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stat-card text-center" style="border-left-color: #3E2723;">
                                    <h3 id="stat-total" style="color: #3E2723;">0</h3>
                                    <p class="text-muted mb-0">Total</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card text-center" style="border-left-color: #4CAF50;">
                                    <h3 id="stat-present" style="color: #4CAF50;">0</h3>
                                    <p class="text-muted mb-0">Presentes</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card text-center" style="border-left-color: #8D6E63;">
                                    <h3 id="stat-absent" style="color: #8D6E63;">0</h3>
                                    <p class="text-muted mb-0">Ausentes</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card text-center" style="border-left-color: #D7CCC8;">
                                    <h3 id="stat-pending" style="color: #6D4C41;">0</h3>
                                    <p class="text-muted mb-0">Pendientes</p>
                                </div>
                            </div>
                        </div>

                        <!-- Lista agrupada por grupos -->
                        <div id="roll-call-groups" style="max-height: 600px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bot√≥n flotante para agregar entrada manual -->
        <button class="btn btn-primary btn-lg rounded-circle position-fixed" 
                style="bottom: 30px; right: 30px; width: 60px; height: 60px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;"
                onclick="showManualEntryModal()"
                title="Agregar entrada manual">
            <i class="bi bi-person-plus-fill" style="font-size: 1.5rem;"></i>
        </button>
    </div>
</div>

<!-- Modal: Entrada Manual -->
<div class="modal fade" id="manualEntryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3E2723 0%, #4E342E 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-person-plus-fill"></i> Agregar Entrada Manual</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualEntryForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nombre completo <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="manualEntryName" required 
                               placeholder="Ej: Juan P√©rez Garc√≠a">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">√Årea/Grupo <span class="text-muted">(opcional)</span></label>
                        <input type="text" class="form-control" id="manualEntryArea" 
                               placeholder="Ej: IT, Administraci√≥n, etc.">
                    </div>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> Esta entrada se agregar√° solo a este pase de lista y ser√° marcada como presente.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="addManualEntry()">
                    <i class="bi bi-plus-circle"></i> Agregar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Tipo de Emergencia -->
<div class="modal fade" id="emergencyTypeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> Activar Emergencia</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="emergencyTypeForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de emergencia</label>
                        <select class="form-select" name="emergency_type" required>
                            <option value="general">General</option>
                            <option value="incendio">üî• Incendio</option>
                            <option value="sismo">üåç Sismo</option>
                            <option value="evacuacion">üö™ Evacuaci√≥n</option>
                            <option value="seguridad">üîí Seguridad</option>
                        </select>
                    </div>
                    
                    <!-- Acciones de dispositivos -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Acciones en dispositivos de la zona</label>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="unlock_doors" id="unlockDoorsCheck" checked>
                                    <label class="form-check-label" for="unlockDoorsCheck">
                                        <i class="bi bi-door-open text-success"></i> <strong>Desbloquear puertas</strong>
                                        <br><small class="text-muted">Abre todas las puertas de los checadores de esta zona</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="trigger_alarms" id="triggerAlarmsCheck">
                                    <label class="form-check-label" for="triggerAlarmsCheck">
                                        <i class="bi bi-bell-fill text-warning"></i> <strong>Activar alarmas</strong>
                                        <br><small class="text-muted">‚ö† Soporte limitado - depende de configuraci√≥n BioStar</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Notas (opcional)</label>
                        <textarea class="form-control" name="notes" rows="2" placeholder="Descripci√≥n adicional..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger btn-lg" onclick="confirmActivateEmergency()">
                    <i class="bi bi-exclamation-triangle-fill"></i> ACTIVAR EMERGENCIA
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedZoneId = null;
let activeEmergencyId = null;
let emergencyEventSource = null;  // SSE para tiempo real
let currentUserName = '{{ current_user.username }}';  // Usuario actual para timestamps

document.addEventListener('DOMContentLoaded', () => {
    loadZones();
    checkEmergencyStatus();
});

async function loadZones() {
    try {
        const response = await fetch('/emergency/api/zones');
        const data = await response.json();
        
        if (data.success) {
            renderZones(data.zones);
        }
    } catch (error) {
        console.error('Error cargando zonas:', error);
    }
}

function renderZones(zones) {
    const container = document.getElementById('zones-container');
    
    if (zones.length === 0) {
        container.innerHTML = '<div class="col-12 text-center"><p class="text-muted">No hay zonas configuradas. Ve a Configuraci√≥n.</p></div>';
        return;
    }
    
    container.innerHTML = zones.map(zone => `
        <div class="col-md-4 mb-3">
            <div class="card zone-card" onclick="selectZone(${zone.id}, '${zone.name}')" style="border-left: 4px solid ${zone.color}; cursor: pointer;">
                <div class="card-body">
                    <h5><i class="${zone.icon}"></i> ${zone.name}</h5>
                    <p class="text-muted small">${zone.description || ''}</p>
                    <span class="badge bg-secondary">${zone.groups_count} grupos</span>
                </div>
            </div>
        </div>
    `).join('');
}

function selectZone(zoneId, zoneName) {
    selectedZoneId = zoneId;
    document.getElementById('selected-zone-display').textContent = zoneName;
    document.getElementById('emergency-button-section').style.display = 'block';
    
    // Scroll al bot√≥n
    document.getElementById('emergency-button-section').scrollIntoView({ behavior: 'smooth' });
}

async function checkEmergencyStatus() {
    try {
        const response = await fetch('/emergency/api/emergency/status');
        const data = await response.json();
        
        if (data.success && data.has_active) {
            showActiveEmergencies(data.emergencies);
            
            // Si hay emergencia en la zona seleccionada, mostrar pase de lista
            const zoneEmergency = data.emergencies.find(e => e.zone_id === selectedZoneId);
            if (zoneEmergency) {
                activeEmergencyId = zoneEmergency.id;
                showRollCall(zoneEmergency.id);
            }
        } else {
            document.getElementById('active-emergencies-alert').style.display = 'none';
        }
    } catch (error) {
        console.error('Error verificando estado:', error);
    }
}

function showActiveEmergencies(emergencies) {
    const alert = document.getElementById('active-emergencies-alert');
    const list = document.getElementById('active-emergencies-list');
    
    list.innerHTML = emergencies.map(e => `
        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded">
            <div>
                <strong>${e.zone_name}</strong> - ${e.emergency_type} 
                <small class="text-muted">(${new Date(e.started_at).toLocaleTimeString()})</small>
            </div>
            <div>
                <button class="btn btn-sm btn-warning me-1" onclick="viewEmergency(${e.id}, ${e.zone_id}, '${e.zone_name}')">
                    <i class="bi bi-eye"></i> Ver
                </button>
                <button class="btn btn-sm btn-success" onclick="quickResolveEmergency(${e.id}, '${e.zone_name}')">
                    <i class="bi bi-check-circle"></i> Resolver
                </button>
            </div>
        </div>
    `).join('');
    
    alert.style.display = 'block';
}

// Ver emergencia activa (mostrar pase de lista)
function viewEmergency(emergencyId, zoneId, zoneName) {
    selectedZoneId = zoneId;
    activeEmergencyId = emergencyId;
    document.getElementById('selected-zone-display').textContent = zoneName;
    showRollCall(emergencyId);
}

// Resolver emergencia r√°pidamente desde la alerta
async function quickResolveEmergency(emergencyId, zoneName) {
    const result = await Swal.fire({
        title: '¬øResolver Emergencia?',
        text: `Esto finalizar√° la emergencia en ${zoneName}`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S√≠, resolver',
        cancelButtonText: 'Cancelar'
    });
    
    if (!result.isConfirmed) return;
    
    try {
        const response = await fetch(`/emergency/api/emergency/${emergencyId}/resolve`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Emergencia Resuelta',
                timer: 2000,
                showConfirmButton: false
            }).then(() => location.reload());
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error resolviendo emergencia');
    }
}

function activateEmergency() {
    if (!selectedZoneId) {
        alert('Selecciona una zona primero');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('emergencyTypeModal'));
    document.getElementById('emergencyTypeForm').reset();
    // Desbloquear puertas marcado por defecto, alarmas desmarcado (soporte limitado)
    document.getElementById('unlockDoorsCheck').checked = true;
    document.getElementById('triggerAlarmsCheck').checked = false;
    modal.show();
}

async function confirmActivateEmergency() {
    const form = document.getElementById('emergencyTypeForm');
    
    // Obtener datos del formulario
    const data = {
        zone_id: selectedZoneId,
        emergency_type: form.querySelector('[name="emergency_type"]').value,
        notes: form.querySelector('[name="notes"]').value,
        unlock_doors: document.getElementById('unlockDoorsCheck').checked,
        trigger_alarms: document.getElementById('triggerAlarmsCheck').checked
    };
    
    // Cerrar modal primero para evitar problemas de aria-hidden
    const modalEl = document.getElementById('emergencyTypeModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
    
    try {
        const response = await fetch('/emergency/api/emergency/activate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            activeEmergencyId = result.emergency_id;
            
            // Construir mensaje detallado de dispositivos
            let deviceHtml = '';
            if (result.devices) {
                const total = result.devices.total || 0;
                const activated = result.devices.activated || [];
                const failed = result.devices.failed || [];
                
                if (total === 0) {
                    deviceHtml = '<p class="text-muted"><i class="bi bi-info-circle"></i> No hay dispositivos asignados a esta zona</p>';
                } else {
                    deviceHtml = `<p><strong>Dispositivos:</strong> ${activated.length}/${total} activados</p>`;
                    
                    if (activated.length > 0) {
                        deviceHtml += '<div class="text-start mt-2"><strong class="text-success">‚úì Activados:</strong><ul class="mb-2">';
                        activated.forEach(d => {
                            let status = [];
                            if (d.unlocked) status.push('üîì Puerta abierta');
                            if (d.alarm) status.push('üîî Alarma');
                            deviceHtml += `<li>${d.name} - ${status.join(', ') || 'Parcial'}</li>`;
                        });
                        deviceHtml += '</ul></div>';
                    }
                    
                    if (failed.length > 0) {
                        deviceHtml += '<div class="text-start"><strong class="text-warning">‚ö† Sin respuesta:</strong><ul>';
                        failed.forEach(d => {
                            deviceHtml += `<li>${d.name}</li>`;
                        });
                        deviceHtml += '</ul></div>';
                    }
                }
            }
            
            Swal.fire({
                icon: 'warning',
                title: '¬°EMERGENCIA ACTIVADA!',
                html: `<p>Emergencia iniciada correctamente.</p>${deviceHtml}`,
                confirmButtonColor: '#dc3545'
            });
            
            showRollCall(result.emergency_id);
            checkEmergencyStatus(); // Actualizar alerta
        } else {
            // Si ya hay emergencia activa, ofrecer verla
            if (result.message && result.message.includes('Ya hay una emergencia activa')) {
                Swal.fire({
                    icon: 'info',
                    title: 'Emergencia Ya Activa',
                    text: 'Ya existe una emergencia activa en esta zona. ¬øDeseas verla?',
                    showCancelButton: true,
                    confirmButtonText: 'Ver emergencia',
                    cancelButtonText: 'Cerrar'
                }).then((res) => {
                    if (res.isConfirmed) {
                        checkEmergencyStatus();
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: result.message
                });
            }
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error activando emergencia'
        });
    }
}

async function showRollCall(emergencyId) {
    document.getElementById('roll-call-section').style.display = 'block';
    document.getElementById('emergency-button-section').style.display = 'none';
    loadRollCall(emergencyId);
    
    // Iniciar SSE para tiempo real
    startEmergencySSE(emergencyId);
}

async function showEmergencyPanel(emergencyId) {
    console.log('üö® Mostrando panel de emergencia:', emergencyId);
    activeEmergencyId = emergencyId;
    
    // Mostrar panel
    document.getElementById('emergency-panel').style.display = 'block';
    document.getElementById('emergency-button-section').style.display = 'none';
    loadRollCall(emergencyId);
    
    // Iniciar SSE para tiempo real
    console.log('üîå Iniciando SSE desde showEmergencyPanel...');
    startEmergencySSE(emergencyId);
}

// ==================== SSE TIEMPO REAL ====================

function startEmergencySSE(emergencyId) {
    if (emergencyEventSource) {
        console.log('‚ö†Ô∏è Cerrando conexi√≥n SSE anterior');
        emergencyEventSource.close();
    }
    
    const sseUrl = `/emergency/stream/emergency/${emergencyId}`;
    console.log('üöÄ Iniciando SSE para emergencia:', emergencyId);
    console.log('üì° URL SSE:', sseUrl);
    
    emergencyEventSource = new EventSource(sseUrl);
    console.log('EventSource creado, estado:', emergencyEventSource.readyState);
    
    emergencyEventSource.addEventListener('connection', (e) => {
        console.log('‚úÖ Conectado a SSE de emergencia');
        console.log('Datos de conexi√≥n:', e.data);
    });
    
    emergencyEventSource.addEventListener('update', (e) => {
        const data = JSON.parse(e.data);
        console.log('üì• Actualizaci√≥n recibida:', data);
        console.log('üìä Stats:', data.stats);
        console.log('üîÑ Cambios recientes:', data.recent_changes);
        
        // Actualizar estad√≠sticas
        if (data.stats) {
            document.getElementById('stat-total').textContent = data.stats.total;
            document.getElementById('stat-present').textContent = data.stats.present;
            document.getElementById('stat-absent').textContent = data.stats.absent;
            document.getElementById('stat-pending').textContent = data.stats.pending;
        }
        
        // Mostrar cambios recientes
        if (data.recent_changes && data.recent_changes.length > 0) {
            data.recent_changes.forEach(change => {
                showRealtimeNotification(change);
                updateMemberStatus(change);
            });
        }
        
        // Mostrar auto-marcados
        if (data.auto_marked && data.auto_marked.length > 0) {
            data.auto_marked.forEach(marked => {
                showAutoMarkedNotification(marked);
            });
            // Recargar lista completa para reflejar cambios
            loadRollCall(activeEmergencyId);
        }
    });
    
    emergencyEventSource.addEventListener('emergency_resolved', (e) => {
        console.log('‚úÖ Emergencia resuelta');
        Swal.fire({
            icon: 'success',
            title: 'Emergencia Resuelta',
            text: 'La emergencia ha sido resuelta',
            timer: 3000
        }).then(() => location.reload());
    });
    
    emergencyEventSource.addEventListener('heartbeat', (e) => {
        console.log('üíì Heartbeat');
    });
    
    emergencyEventSource.onopen = (e) => {
        console.log('üîì Conexi√≥n SSE abierta');
        console.log('Estado:', emergencyEventSource.readyState);
    };
    
    emergencyEventSource.onerror = (error) => {
        console.error('‚ùå Error en SSE:', error);
        console.error('Estado de conexi√≥n:', emergencyEventSource.readyState);
        console.error('0=CONNECTING, 1=OPEN, 2=CLOSED');
        
        if (emergencyEventSource.readyState === EventSource.CLOSED) {
            console.log('‚ö†Ô∏è Conexi√≥n cerrada, reconectando en 3 segundos...');
            setTimeout(() => startEmergencySSE(emergencyId), 3000);
        }
    };
}

function showRealtimeNotification(change) {
    const statusText = change.status === 'present' ? 'PRESENTE' : 'AUSENTE';
    const statusClass = change.status === 'present' ? 'success' : 'danger';
    
    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: change.status === 'present' ? 'success' : 'error',
        title: `${change.user_name}`,
        text: `Marcado como ${statusText} por ${change.marked_by}`,
        showConfirmButton: false,
        timer: 3000
    });
}

function showAutoMarkedNotification(marked) {
    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'info',
        title: `‚úÖ ${marked.user_name}`,
        text: `Auto-detectado en ${marked.device}`,
        showConfirmButton: false,
        timer: 4000
    });
}

function updateMemberStatus(change) {
    // Buscar y actualizar el bot√≥n del miembro en la UI
    const buttons = document.querySelectorAll(`button[onclick*="markAttendance(${change.id}"]`);
    buttons.forEach(btn => {
        const row = btn.closest('.list-group-item');
        if (row) {
            // Actualizar clases de botones
            const presentBtn = row.querySelector('.btn-success, .btn-outline-success');
            const absentBtn = row.querySelector('.btn-danger, .btn-outline-danger');
            
            if (change.status === 'present') {
                presentBtn?.classList.remove('btn-outline-success');
                presentBtn?.classList.add('btn-success');
                absentBtn?.classList.remove('btn-danger');
                absentBtn?.classList.add('btn-outline-danger');
            } else {
                absentBtn?.classList.remove('btn-outline-danger');
                absentBtn?.classList.add('btn-danger');
                presentBtn?.classList.remove('btn-success');
                presentBtn?.classList.add('btn-outline-success');
            }
        }
    });
}

async function loadRollCall(emergencyId, preserveExpandedState = false) {
    try {
        // Actualizar bot√≥n de exportar Excel
        const exportBtn = document.getElementById('exportExcelBtn');
        if (exportBtn && emergencyId) {
            exportBtn.href = `/emergency/api/emergency/${emergencyId}/export-excel`;
            exportBtn.style.display = 'inline-block';
        }
        
        const response = await fetch(`/emergency/api/emergency/${emergencyId}/roll-call`);
        const data = await response.json();
        
        if (data.success) {
            renderRollCall(data.groups, preserveExpandedState);
            updateStats(data.groups);
        }
    } catch (error) {
        console.error('Error cargando pase de lista:', error);
    }
}

function renderRollCall(groups, preserveExpandedState = false) {
    const container = document.getElementById('roll-call-groups');
    
    // Guardar estado de grupos expandidos antes de re-renderizar
    const expandedGroups = new Set();
    if (preserveExpandedState) {
        document.querySelectorAll('.collapse.show').forEach(collapse => {
            const groupIndex = collapse.id.replace('group-', '');
            expandedGroups.add(parseInt(groupIndex));
        });
    }
    
    container.innerHTML = groups.map((group, index) => {
        const isExpanded = preserveExpandedState && expandedGroups.has(index);
        return `
        <div class="card mb-2" style="border-left: 4px solid ${group.group_color};">
            <div class="card-header p-2" style="background-color: ${group.group_color}20; cursor: pointer;" 
                 data-bs-toggle="collapse" data-bs-target="#group-${index}" aria-expanded="${isExpanded}">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi ${isExpanded ? 'bi-chevron-down' : 'bi-chevron-right'} collapse-icon" id="icon-${index}"></i>
                        <i class="bi bi-people-fill ms-2"></i> ${group.group_name}
                    </h6>
                    <span class="badge bg-secondary">${group.members.length} personas</span>
                </div>
            </div>
            <div id="group-${index}" class="collapse ${isExpanded ? 'show' : ''}">
                <div class="card-body p-2">
                    <div class="list-group list-group-flush">
                        ${group.members.map(member => `
                            <div class="list-group-item px-2 py-3" data-entry-id="${member.id}">
                                <div class="row align-items-center">
                                    <div class="col-12 col-md-4 mb-2 mb-md-0">
                                        <strong class="d-block">${member.user_name}</strong>
                                        <small class="text-muted">ID: ${member.biostar_user_id}</small>
                                    </div>
                                    <div class="col-12 col-md-5 mb-2 mb-md-0">
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-sm ${member.status === 'present' ? 'btn-success' : 'btn-outline-success'}" 
                                                    onclick="markAttendance(${member.id}, 'present')">
                                                <i class="bi bi-check-circle"></i> Presente
                                            </button>
                                            <button class="btn btn-sm ${member.status === 'absent' ? 'btn-danger' : 'btn-outline-danger'}" 
                                                    onclick="markAttendance(${member.id}, 'absent')">
                                                <i class="bi bi-x-circle"></i> Ausente
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <small class="text-muted timestamp-info d-block text-md-end">
                                            ${member.marked_at ? 
                                                `${new Date(member.marked_at).toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'})} por ${member.marked_by}` 
                                                : '<span class="text-warning">Sin marcar</span>'}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;}).join('');
    
    // Agregar listeners para rotar el √≠cono de chevron
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach((el, index) => {
        el.addEventListener('click', function() {
            const icon = document.getElementById(`icon-${index}`);
            icon.classList.toggle('bi-chevron-right');
            icon.classList.toggle('bi-chevron-down');
        });
    });
}

function updateStats(groups) {
    let total = 0;
    let present = 0;
    let absent = 0;
    let pending = 0;
    
    groups.forEach(group => {
        group.members.forEach(member => {
            total++;
            if (member.status === 'present') present++;
            else if (member.status === 'absent') absent++;
            else pending++;
        });
    });
    
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-present').textContent = present;
    document.getElementById('stat-absent').textContent = absent;
    document.getElementById('stat-pending').textContent = pending;
}

async function markAttendance(entryId, status) {
    try {
        // Actualizaci√≥n optimista: actualizar UI inmediatamente
        updateButtonsOptimistic(entryId, status);
        
        const response = await fetch(`/emergency/api/roll-call/${entryId}/mark`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Actualizar timestamp inmediatamente
            updateTimestampOptimistic(entryId);
            // Recargar para obtener datos completos del servidor, preservando grupos expandidos
            loadRollCall(activeEmergencyId, true);
        } else {
            alert('Error: ' + data.message);
            // Revertir cambio optimista si fall√≥
            loadRollCall(activeEmergencyId, true);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error marcando asistencia');
        // Revertir cambio optimista si fall√≥
        loadRollCall(activeEmergencyId);
    }
}

function updateButtonsOptimistic(entryId, status) {
    // Actualizar botones inmediatamente sin esperar respuesta del servidor
    const entry = document.querySelector(`[data-entry-id="${entryId}"]`);
    if (!entry) return;
    
    const presentBtn = entry.querySelector('.btn-success, .btn-outline-success');
    const absentBtn = entry.querySelector('.btn-danger, .btn-outline-danger');
    
    if (status === 'present') {
        presentBtn?.classList.remove('btn-outline-success');
        presentBtn?.classList.add('btn-success');
        absentBtn?.classList.remove('btn-danger');
        absentBtn?.classList.add('btn-outline-danger');
    } else if (status === 'absent') {
        absentBtn?.classList.remove('btn-outline-danger');
        absentBtn?.classList.add('btn-danger');
        presentBtn?.classList.remove('btn-success');
        presentBtn?.classList.add('btn-outline-success');
    }
}

function updateTimestampOptimistic(entryId) {
    // Actualizar timestamp inmediatamente
    const entry = document.querySelector(`[data-entry-id="${entryId}"]`);
    if (!entry) return;
    
    const timestamp = entry.querySelector('.timestamp-info');
    if (timestamp) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
        timestamp.innerHTML = `${timeStr} por ${currentUserName || 'admin'}`;
    }
}

function showManualEntryModal() {
    if (!activeEmergencyId) {
        alert('No hay emergencia activa');
        return;
    }
    
    document.getElementById('manualEntryForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('manualEntryModal'));
    modal.show();
}

async function addManualEntry() {
    const name = document.getElementById('manualEntryName').value.trim();
    const area = document.getElementById('manualEntryArea').value.trim();
    
    if (!name) {
        alert('El nombre es requerido');
        return;
    }
    
    if (!activeEmergencyId) {
        alert('No hay emergencia activa');
        return;
    }
    
    try {
        const response = await fetch(`/emergency/api/emergency/${activeEmergencyId}/manual-entry`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                area: area || 'Manual'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('manualEntryModal')).hide();
            Swal.fire({
                icon: 'success',
                title: 'Entrada agregada',
                text: `${name} ha sido agregado al pase de lista`,
                timer: 2000,
                showConfirmButton: false
            });
            loadRollCall(activeEmergencyId);
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error agregando entrada manual');
    }
}

async function resolveEmergency() {
    const result = await Swal.fire({
        title: '¬øResolver Emergencia?',
        html: '<p>Esto cerrar√° el pase de lista y finalizar√° la emergencia.</p><p><strong>Las puertas volver√°n a modo normal.</strong></p>',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S√≠, resolver',
        cancelButtonText: 'Cancelar'
    });
    
    if (!result.isConfirmed) return;
    
    // Mostrar loading
    Swal.fire({
        title: 'Resolviendo emergencia...',
        html: '<p>Cerrando puertas y guardando pase de lista...</p>',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
    
    try {
        const response = await fetch(`/emergency/api/emergency/${activeEmergencyId}/resolve`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Cerrar SSE
            if (emergencyEventSource) {
                emergencyEventSource.close();
            }
            
            // Construir mensaje con estado de puertas
            let doorsHtml = '';
            if (data.doors && data.doors.total > 0) {
                const released = data.doors.released?.length || 0;
                const failed = data.doors.failed?.length || 0;
                
                if (released > 0) {
                    doorsHtml += `<p class="text-success"><i class="bi bi-check-circle-fill"></i> ${released} puerta(s) volvieron a modo normal</p>`;
                }
                if (failed > 0) {
                    doorsHtml += `<p class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> ${failed} puerta(s) no pudieron cerrarse</p>`;
                }
            }
            
            Swal.fire({
                icon: 'success',
                title: '‚úÖ Emergencia Resuelta',
                html: `
                    <p>El pase de lista ha sido guardado.</p>
                    ${doorsHtml || '<p class="text-muted">No hab√≠a puertas desbloqueadas.</p>'}
                `,
                confirmButtonColor: '#28a745'
            }).then(() => location.reload());
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'Error resolviendo emergencia', 'error');
    }
}

// Limpiar SSE al salir de la p√°gina
window.addEventListener('beforeunload', () => {
    if (emergencyEventSource) {
        emergencyEventSource.close();
    }
});
</script>

<style>
.zone-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: all 0.2s;
}

#activateEmergencyBtn {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #6c757d;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Centrar modales totalmente (vertical + horizontal) */
.modal-dialog-centered {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - 1rem);
    margin: 0.5rem auto;
}

.modal.fade .modal-dialog-centered {
    transform: translate(0, -50px);
}

.modal.show .modal-dialog-centered {
    transform: none;
}

/* Mejoras responsive para m√≥vil */
@media (max-width: 768px) {
    .list-group-item {
        padding: 0.75rem 0.5rem !important;
    }
    
    .btn-group-sm .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.5rem;
    }
    
    .timestamp-info {
        font-size: 0.75rem;
        display: block;
        margin-top: 0.25rem;
    }
    
    /* Bot√≥n flotante m√°s peque√±o en m√≥vil */
    .position-fixed.btn-lg {
        width: 50px !important;
        height: 50px !important;
        bottom: 20px !important;
        right: 20px !important;
    }
    
    .position-fixed.btn-lg i {
        font-size: 1.2rem !important;
    }
}
</style>
{% endblock %}
