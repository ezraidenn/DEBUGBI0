{% extends "base.html" %}
{% block title %}Historial{% endblock %}

{% block extra_css %}
<style>
    /* EMERGENCY HISTORY V5 - PREMIUM PROFESSIONAL */
    /* Inspired by Linear, Stripe, Notion */

    .eh {
        font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
        -webkit-font-smoothing: antialiased;
        background: linear-gradient(180deg, #fafbfc 0%, #ffffff 100%);
        min-height: 100vh;
    }

    /* === HEADER === */
    .eh-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        margin-bottom: 24px;
    }

    .eh-header h1 {
        font-size: 22px;
        font-weight: 700;
        color: #0f172a;
        margin: 0;
        letter-spacing: -0.3px;
    }

    .eh-header a {
        font-size: 13px;
        font-weight: 500;
        color: #6366f1;
        text-decoration: none;
        padding: 8px 14px;
        background: rgba(99, 102, 241, 0.08);
        border-radius: 8px;
        transition: all 0.2s;
    }

    .eh-header a:hover {
        background: rgba(99, 102, 241, 0.15);
    }

    /* === FILTERS === */
    .eh-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
    }

    .eh-search {
        position: relative;
        flex: 1;
        min-width: 200px;
    }

    .eh-search i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 14px;
    }

    .eh-search input {
        width: 100%;
        padding: 11px 14px 11px 40px;
        font-size: 14px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        background: #fff;
        color: #1e293b;
        transition: all 0.2s;
    }

    .eh-search input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
    }

    .eh-select {
        padding: 11px 36px 11px 14px;
        font-size: 14px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M4 6l4 4 4-4'/%3E%3C/svg%3E") no-repeat right 12px center;
        color: #1e293b;
        cursor: pointer;
        min-width: 150px;
        -webkit-appearance: none;
    }

    .eh-select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
    }

    .eh-date {
        padding: 11px 14px;
        font-size: 14px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        background: #fff;
        color: #1e293b;
        min-width: 150px;
    }

    .eh-date:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
    }

    .eh-clear {
        padding: 11px 16px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        background: #fff;
        color: #64748b;
        cursor: pointer;
        transition: all 0.15s;
    }

    .eh-clear:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }

    /* === TABLE === */
    .eh-table {
        background: #fff;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 4px 12px rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .eh-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .eh-table thead th {
        padding: 14px 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        color: #64748b;
        background: #f8fafc;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }

    .eh-table tbody tr {
        transition: background 0.1s;
    }

    .eh-table tbody tr:hover {
        background: #f8fafc;
    }

    .eh-table tbody td {
        padding: 18px 20px;
        font-size: 14px;
        color: #334155;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .eh-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Zone cell */
    .eh-zone {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .eh-zone-icon {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .eh-zone-icon.general {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        color: #64748b;
    }

    .eh-zone-icon.incendio {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        color: #ef4444;
    }

    .eh-zone-icon.sismo {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        color: #f59e0b;
    }

    .eh-zone-icon.evacuacion {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        color: #3b82f6;
    }

    .eh-zone-icon.seguridad {
        background: linear-gradient(135deg, #faf5ff 0%, #ede9fe 100%);
        color: #8b5cf6;
    }

    .eh-zone-info {
        line-height: 1.4;
    }

    .eh-zone-name {
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 2px;
    }

    .eh-zone-meta {
        font-size: 12px;
        color: #94a3b8;
    }

    /* Type badge */
    .eh-type {
        display: inline-flex;
        align-items: center;
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .eh-type.general {
        background: #f1f5f9;
        color: #475569;
    }

    .eh-type.incendio {
        background: #fef2f2;
        color: #dc2626;
    }

    .eh-type.sismo {
        background: #fffbeb;
        color: #d97706;
    }

    .eh-type.evacuacion {
        background: #eff6ff;
        color: #2563eb;
    }

    .eh-type.seguridad {
        background: #faf5ff;
        color: #7c3aed;
    }

    /* Stats */
    .eh-stats {
        display: flex;
        gap: 6px;
    }

    .eh-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px 12px;
        background: #f8fafc;
        border-radius: 8px;
        min-width: 48px;
    }

    .eh-stat-num {
        font-size: 16px;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 3px;
    }

    .eh-stat-label {
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: #94a3b8;
    }

    .eh-stat.total .eh-stat-num {
        color: #0f172a;
    }

    .eh-stat.present .eh-stat-num {
        color: #22c55e;
    }

    .eh-stat.absent .eh-stat-num {
        color: #ef4444;
    }

    .eh-stat.pending .eh-stat-num {
        color: #f59e0b;
    }

    /* Actions */
    .eh-actions {
        display: flex;
        gap: 8px;
    }

    .eh-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 9px 14px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.15s;
    }

    .eh-btn-excel {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        color: #059669;
    }

    .eh-btn-excel:hover {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        transform: translateY(-1px);
    }

    .eh-btn-del {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        color: #dc2626;
        padding: 9px 11px;
    }

    .eh-btn-del:hover {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        transform: translateY(-1px);
    }

    /* === PAGINATION === */
    .eh-pag {
        display: flex;
        justify-content: center;
        gap: 6px;
        margin-top: 24px;
    }

    .eh-pag-btn {
        min-width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 500;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        color: #334155;
        cursor: pointer;
        transition: all 0.15s;
    }

    .eh-pag-btn:hover:not(.disabled):not(.active) {
        background: #f8fafc;
        border-color: #cbd5e1;
    }

    .eh-pag-btn.active {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        border-color: transparent;
        color: #fff;
    }

    .eh-pag-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    /* === STATES === */
    .eh-empty {
        text-align: center;
        padding: 60px 24px;
    }

    .eh-empty i {
        font-size: 40px;
        color: #cbd5e1;
    }

    .eh-empty h3 {
        margin: 16px 0 6px;
        font-size: 16px;
        font-weight: 600;
        color: #334155;
    }

    .eh-empty p {
        margin: 0;
        font-size: 14px;
        color: #94a3b8;
    }

    .eh-spin {
        width: 28px;
        height: 28px;
        border: 3px solid #e2e8f0;
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin: 0 auto 12px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* === MOBILE === */
    @media (max-width: 900px) {
        .eh-table thead {
            display: none;
        }

        .eh-table tbody tr {
            display: flex;
            flex-direction: column;
            padding: 16px 18px;
            gap: 14px;
            border-bottom: 1px solid #e2e8f0;
        }

        .eh-table tbody td {
            padding: 0;
            border: none;
        }

        .eh-zone-icon {
            width: 38px;
            height: 38px;
            font-size: 16px;
        }

        .eh-stats {
            justify-content: space-between;
        }

        .eh-stat {
            flex: 1;
        }

        .eh-actions {
            padding-top: 12px;
            border-top: 1px solid #f1f5f9;
        }

        .eh-btn {
            flex: 1;
            justify-content: center;
        }
    }

    @media (max-width: 600px) {
        .eh-header {
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }

        .eh-filters {
            flex-direction: column;
        }

        .eh-search,
        .eh-select,
        .eh-date {
            width: 100%;
            min-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="eh">

    <div class="eh-header">
        <h1>Historial de Emergencias</h1>
        <a href="{{ url_for('emergency.emergency_page') }}"><i class="bi bi-arrow-left"></i> Volver</a>
    </div>

    <div class="eh-filters">
        <div class="eh-search">
            <i class="bi bi-search"></i>
            <input type="text" id="search" placeholder="Buscar zona...">
        </div>
        <select id="type" class="eh-select">
            <option value="">Todos los tipos</option>
            <option value="general">General</option>
            <option value="incendio">Incendio</option>
            <option value="sismo">Sismo</option>
            <option value="evacuacion">Evacuación</option>
            <option value="seguridad">Seguridad</option>
        </select>
        <input type="date" id="date" class="eh-date">
        <button class="eh-clear" onclick="clearFilters()"><i class="bi bi-x"></i> Limpiar</button>
    </div>

    <div class="eh-table">
        <table>
            <thead>
                <tr>
                    <th>Zona</th>
                    <th>Tipo</th>
                    <th>Estadísticas</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tbody">
                <tr>
                    <td colspan="4">
                        <div class="eh-empty">
                            <div class="eh-spin"></div>
                            <h3>Cargando...</h3>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="eh-pag" id="pag"></div>

</div>

<div class="modal fade" id="delModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content" style="border-radius:14px;border:none;overflow:hidden;">
            <div class="modal-body text-center" style="padding:28px 24px;">
                <div
                    style="width:52px;height:52px;background:linear-gradient(135deg,#fef2f2,#fee2e2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 14px;">
                    <i class="bi bi-trash3" style="font-size:22px;color:#ef4444;"></i>
                </div>
                <h5 style="margin:0 0 6px;font-weight:600;color:#0f172a;">Eliminar registro</h5>
                <p style="margin:0;color:#64748b;font-size:13px;">Esta acción no se puede deshacer.</p>
            </div>
            <div style="display:flex;border-top:1px solid #e2e8f0;">
                <button type="button"
                    style="flex:1;padding:14px;background:none;border:none;font-size:14px;font-weight:500;color:#64748b;cursor:pointer;"
                    data-bs-dismiss="modal">Cancelar</button>
                <button type="button"
                    style="flex:1;padding:14px;background:none;border:none;border-left:1px solid #e2e8f0;font-size:14px;font-weight:600;color:#ef4444;cursor:pointer;"
                    onclick="confirmDel()">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<script>
    const T = { general: { i: 'bi-exclamation-circle', l: 'General' }, incendio: { i: 'bi-fire', l: 'Incendio' }, sismo: { i: 'bi-broadcast', l: 'Sismo' }, evacuacion: { i: 'bi-door-open', l: 'Evacuación' }, seguridad: { i: 'bi-shield-check', l: 'Seguridad' } };
    let page = 1, delId = null, modal = null;

    document.addEventListener('DOMContentLoaded', () => {
        const m = document.getElementById('delModal');
        if (m && bootstrap) modal = new bootstrap.Modal(m);
        load();
    });

    async function load(p = 1) {
        document.getElementById('tbody').innerHTML = '<tr><td colspan="4"><div class="eh-empty"><div class="eh-spin"></div><h3>Cargando...</h3></div></td></tr>';
        try {
            const z = document.getElementById('search').value.trim(), t = document.getElementById('type').value, d = document.getElementById('date').value;
            let url = `/emergency/api/emergencies/history?page=${p}&per_page=12`;
            if (z) url += `&zone=${encodeURIComponent(z)}`;
            if (t) url += `&type=${encodeURIComponent(t)}`;
            if (d) url += `&date=${encodeURIComponent(d)}`;
            const r = await fetch(url), data = await r.json();
            if (data.success) { render(data.emergencies); pag(data.pagination); page = p; }
        } catch { document.getElementById('tbody').innerHTML = '<tr><td colspan="4"><div class="eh-empty"><i class="bi bi-wifi-off"></i><h3>Error de conexión</h3></div></td></tr>'; }
    }

    function render(items) {
        if (!items?.length) { document.getElementById('tbody').innerHTML = '<tr><td colspan="4"><div class="eh-empty"><i class="bi bi-inbox"></i><h3>Sin registros</h3><p>No hay emergencias</p></div></td></tr>'; document.getElementById('pag').innerHTML = ''; return; }
        document.getElementById('tbody').innerHTML = items.map(e => {
            const t = T[e.emergency_type] || T.general;
            return `<tr>
            <td><div class="eh-zone"><div class="eh-zone-icon ${e.emergency_type}"><i class="bi ${t.i}"></i></div><div class="eh-zone-info"><div class="eh-zone-name">${e.zone_name}</div><div class="eh-zone-meta">${e.started_at} · ${e.duration} · ${e.started_by_name}</div></div></div></td>
            <td><span class="eh-type ${e.emergency_type}">${t.l}</span></td>
            <td><div class="eh-stats"><div class="eh-stat total"><span class="eh-stat-num">${e.stats.total}</span><span class="eh-stat-label">Total</span></div><div class="eh-stat present"><span class="eh-stat-num">${e.stats.present}</span><span class="eh-stat-label">Pres</span></div><div class="eh-stat absent"><span class="eh-stat-num">${e.stats.absent}</span><span class="eh-stat-label">Aus</span></div><div class="eh-stat pending"><span class="eh-stat-num">${e.stats.pending}</span><span class="eh-stat-label">Pend</span></div></div></td>
            <td><div class="eh-actions"><button class="eh-btn eh-btn-excel" onclick="excel(${e.id})"><i class="bi bi-file-earmark-excel"></i> Excel</button>${e.can_delete ? `<button class="eh-btn eh-btn-del" onclick="del(${e.id})"><i class="bi bi-trash3"></i></button>` : ''}</div></td>
        </tr>`;
        }).join('');
    }

    function pag(p) {
        if (!p || p.pages <= 1) { document.getElementById('pag').innerHTML = ''; return; }
        let h = `<button class="eh-pag-btn ${!p.has_prev ? 'disabled' : ''}" onclick="${p.has_prev ? 'load(' + (p.page - 1) + ')' : ''}"><i class="bi bi-chevron-left"></i></button>`;
        for (let i = 1; i <= p.pages; i++) { if (i === 1 || i === p.pages || Math.abs(i - p.page) <= 1) h += `<button class="eh-pag-btn ${i === p.page ? 'active' : ''}" onclick="load(${i})">${i}</button>`; else if (Math.abs(i - p.page) === 2) h += `<span class="eh-pag-btn disabled">…</span>`; }
        h += `<button class="eh-pag-btn ${!p.has_next ? 'disabled' : ''}" onclick="${p.has_next ? 'load(' + (p.page + 1) + ')' : ''}"><i class="bi bi-chevron-right"></i></button>`;
        document.getElementById('pag').innerHTML = h;
    }

    let ft;
    document.getElementById('search').addEventListener('input', () => { clearTimeout(ft); ft = setTimeout(() => load(1), 300); });
    document.getElementById('type').addEventListener('change', () => load(1));
    document.getElementById('date').addEventListener('change', () => load(1));

    function clearFilters() { document.getElementById('search').value = ''; document.getElementById('type').value = ''; document.getElementById('date').value = ''; load(1); }
    function excel(id) { const a = document.createElement('a'); a.href = `/emergency/api/emergency/${id}/export-excel`; a.download = `emergencia_${id}.xlsx`; document.body.appendChild(a); a.click(); a.remove(); }
    function del(id) { delId = id; if (modal) modal.show(); }
    async function confirmDel() { if (!delId) return; try { await fetch(`/emergency/api/emergency/${delId}`, { method: 'DELETE' }); load(page); } catch { } if (modal) modal.hide(); delId = null; }
</script>
{% endblock %}